<!DOCTYPE html>
<html lang="pt">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
<meta name="theme-color" content="#0a1628">
<title>MARINHA ‚Äì Painel da Loja</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700;900&family=DM+Sans:wght@400;600;700;800&display=swap" rel="stylesheet">
<style>
:root {
  --navy:#0a1628;--sea:#1a4a8a;--gold:#c9a84c;--gold-l:#e8c97a;
  --cream:#f5f0e8;--bg:#f4f1ec;--muted:#7a8a9a;
  --green:#27ae60;--red:#e74c3c;--text:#1a2332;
}
*{box-sizing:border-box;margin:0;padding:0;-webkit-tap-highlight-color:transparent;}
html,body{height:100%;font-family:'DM Sans',sans-serif;background:var(--bg);color:var(--text);}

/* ‚îÄ‚îÄ‚îÄ PIN ‚îÄ‚îÄ‚îÄ */
#ecra-pin{
  position:fixed;inset:0;z-index:1000;
  background:linear-gradient(160deg,var(--navy),var(--sea));
  display:flex;flex-direction:column;align-items:center;justify-content:center;
  gap:20px;padding:32px;
}
.pin-titulo{font-family:'Playfair Display',serif;font-size:36px;color:var(--cream);letter-spacing:6px;}
.pin-sub{color:var(--gold);font-size:11px;letter-spacing:3px;text-transform:uppercase;}
.pin-dots{display:flex;gap:14px;margin:8px 0;}
.pin-dot{
  width:16px;height:16px;border-radius:50%;
  border:2px solid rgba(255,255,255,.3);background:transparent;
  transition:.15s;
}
.pin-dot.preenchido{background:var(--gold);border-color:var(--gold);}
.pin-teclado{display:grid;grid-template-columns:repeat(3,72px);gap:12px;}
.pin-btn{
  height:72px;border:none;border-radius:18px;
  background:rgba(255,255,255,.1);color:#fff;
  font-family:'DM Sans',sans-serif;font-size:24px;font-weight:700;
  cursor:pointer;transition:transform .1s,background .1s;
}
.pin-btn:active{transform:scale(.93);background:rgba(255,255,255,.2);}
.pin-btn-apagar{font-size:18px;}
.pin-erro{color:var(--red);font-size:13px;font-weight:600;min-height:20px;}

/* ‚îÄ‚îÄ‚îÄ APP LOJA ‚îÄ‚îÄ‚îÄ */
#app-loja{display:none;flex-direction:column;min-height:100vh;}
#app-loja.visivel{display:flex;}

.cabecalho{
  position:fixed;top:0;left:0;right:0;z-index:100;height:60px;
  background:linear-gradient(135deg,var(--navy),var(--sea));
  display:flex;align-items:center;gap:12px;padding:0 16px;
  box-shadow:0 3px 16px rgba(0,0,0,.25);
}
.btn-back{
  width:36px;height:36px;background:rgba(255,255,255,.1);border:none;
  border-radius:50%;cursor:pointer;display:flex;align-items:center;justify-content:center;flex-shrink:0;
}
.btn-back svg{stroke:rgba(255,255,255,.85);}
.cab-titulo{color:#fff;font-size:17px;font-weight:700;flex:1;}
.cab-sub{color:rgba(255,255,255,.5);font-size:10px;letter-spacing:2px;text-transform:uppercase;}

.navbar{
  position:fixed;bottom:0;left:0;right:0;z-index:100;
  background:#fff;border-top:1px solid rgba(0,0,0,.07);
  display:flex;height:70px;box-shadow:0 -3px 18px rgba(0,0,0,.07);
}
.nav-btn{
  flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;
  gap:3px;border:none;background:none;cursor:pointer;
  font-family:'DM Sans',sans-serif;font-size:10px;font-weight:700;
  letter-spacing:.5px;text-transform:uppercase;color:var(--muted);transition:color .15s;padding:8px 4px;
}
.nav-btn svg{width:22px;height:22px;stroke:currentColor;fill:none;stroke-width:1.8;}
.nav-btn.ativo{color:var(--navy);}
.nav-btn.ativo svg{stroke:var(--gold);}

.ecra{display:none;padding:76px 0 82px;min-height:100vh;}
.ecra.ativo{display:block;}
.secao{padding:0 16px;}
.gap{height:18px;}

.card{background:#fff;border-radius:16px;padding:18px;box-shadow:0 2px 12px rgba(10,22,40,.06);margin-bottom:14px;}
.card-titulo{font-size:11px;font-weight:700;color:var(--muted);letter-spacing:1.5px;text-transform:uppercase;margin-bottom:14px;}
.btn-p{width:100%;padding:15px;background:linear-gradient(135deg,var(--gold),var(--gold-l));color:var(--navy);border:none;border-radius:14px;font-family:'DM Sans',sans-serif;font-weight:800;font-size:15px;cursor:pointer;}
.btn-s{width:100%;padding:13px;background:#eef2f7;color:var(--sea);border:1.5px solid rgba(26,74,138,.18);border-radius:14px;font-family:'DM Sans',sans-serif;font-weight:700;font-size:14px;cursor:pointer;}
.btn-d{width:100%;padding:13px;background:rgba(231,76,60,.07);color:var(--red);border:1.5px solid rgba(231,76,60,.18);border-radius:14px;font-family:'DM Sans',sans-serif;font-weight:700;font-size:14px;cursor:pointer;}
.campo{width:100%;padding:12px 14px;background:#eef2f7;border:1.5px solid rgba(26,74,138,.14);border-radius:12px;font-family:'DM Sans',sans-serif;font-size:15px;color:var(--text);outline:none;margin-bottom:10px;}
.campo:focus{border-color:var(--sea);box-shadow:0 0 0 3px rgba(26,74,138,.1);}
.label{font-size:11px;font-weight:700;color:var(--muted);letter-spacing:1px;text-transform:uppercase;margin-bottom:5px;display:block;}
.row{display:flex;gap:10px;}
.row>*{flex:1;}

/* hero */
.hero-loja{background:linear-gradient(135deg,var(--navy),var(--sea));padding:28px 20px 42px;position:relative;overflow:hidden;}
.hero-loja::after{content:'';position:absolute;bottom:-20px;left:0;right:0;height:40px;background:var(--bg);border-radius:50% 50% 0 0/100% 100% 0 0;}
.hero-nome{color:rgba(255,255,255,.5);font-size:12px;margin-bottom:2px;}
.hero-loja-nome{color:#fff;font-size:21px;font-weight:700;margin-bottom:20px;}
.stats-grid{display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px;}
.stat-box{background:rgba(255,255,255,.1);border-radius:14px;padding:14px 8px;text-align:center;}
.stat-val{color:var(--gold);font-size:24px;font-weight:800;line-height:1;}
.stat-lbl{color:rgba(255,255,255,.4);font-size:10px;margin-top:3px;letter-spacing:.5px;}

/* clientes */
.barra-pesquisa{background:#fff;padding:10px 14px;display:flex;align-items:center;gap:10px;border-bottom:1px solid rgba(0,0,0,.05);position:sticky;top:60px;z-index:10;}
.barra-pesquisa input{flex:1;border:none;outline:none;font-family:'DM Sans',sans-serif;font-size:15px;background:transparent;}
.cli-row{display:flex;align-items:center;gap:12px;padding:13px 16px;border-bottom:1px solid rgba(0,0,0,.045);cursor:pointer;background:#fff;}
.cli-row:active{background:#f0f4fa;}
.avatar{width:44px;height:44px;border-radius:50%;flex-shrink:0;background:linear-gradient(135deg,var(--navy),var(--sea));color:var(--gold);font-weight:800;font-size:18px;display:flex;align-items:center;justify-content:center;}
.cli-pts-val{font-size:19px;font-weight:800;color:var(--navy);text-align:right;}
.cli-pts-lbl{font-size:10px;color:var(--muted);text-align:right;}

/* promos */
.promos-grid{display:grid;grid-template-columns:1fr 1fr;gap:12px;}
.promo-card{background:#fff;border-radius:14px;overflow:hidden;box-shadow:0 2px 10px rgba(10,22,40,.07);cursor:pointer;}
.promo-img{width:100%;background:#eef2f7;display:flex;align-items:center;justify-content:center;font-size:32px;position:relative;flex-shrink:0;}
.promo-img img{width:100%;height:auto;display:block;}
.badge-desc{position:absolute;top:6px;left:6px;background:var(--red);color:#fff;font-size:10px;font-weight:700;padding:2px 7px;border-radius:6px;}
.promo-body{padding:10px;}
.promo-nome{font-size:13px;font-weight:700;margin-bottom:3px;}
.promo-sub{font-size:11px;color:var(--muted);margin-bottom:5px;}
.preco-linha{display:flex;align-items:center;gap:6px;}
.preco-orig{font-size:11px;color:var(--muted);text-decoration:line-through;}
.preco-novo{font-size:16px;font-weight:800;color:var(--red);}

/* folheto */
.folheto-strip{display:flex;gap:10px;overflow-x:auto;padding:4px 0 8px;scrollbar-width:none;}
.folheto-strip::-webkit-scrollbar{display:none;}
.fol-thumb{flex-shrink:0;width:88px;height:118px;border-radius:12px;background:#eef2f7;border:2px solid transparent;cursor:pointer;overflow:hidden;display:flex;align-items:center;justify-content:center;font-size:28px;transition:transform .15s;}
.fol-thumb:active{transform:scale(.95);}
.fol-thumb img{width:100%;height:100%;object-fit:cover;}

/* scanner */
.scan-wrap{background:var(--navy);min-height:calc(100vh - 60px);display:flex;flex-direction:column;align-items:center;padding:24px 16px;gap:16px;}
.scan-titulo{color:var(--gold);font-size:11px;letter-spacing:2px;text-transform:uppercase;}
.scan-sub{color:rgba(255,255,255,.55);font-size:13px;text-align:center;line-height:1.6;}
.btn-camera{width:100%;padding:20px;background:linear-gradient(135deg,var(--gold),var(--gold-l));color:var(--navy);border:none;border-radius:18px;font-family:'DM Sans',sans-serif;font-weight:800;font-size:16px;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:12px;}
.sep-ou{width:100%;display:flex;align-items:center;gap:10px;}
.sep-ou::before,.sep-ou::after{content:'';flex:1;height:1px;background:rgba(255,255,255,.12);}
.sep-ou span{color:rgba(255,255,255,.3);font-size:12px;}
.campo-dark{width:100%;padding:14px;background:rgba(255,255,255,.08);border:1.5px solid rgba(255,255,255,.18);border-radius:14px;font-family:'DM Sans',sans-serif;font-size:15px;color:#fff;outline:none;}
.campo-dark::placeholder{color:rgba(255,255,255,.3);}
.scan-resultados{width:100%;max-height:220px;overflow-y:auto;}
.scan-res-item{display:flex;align-items:center;gap:12px;padding:12px;border-radius:12px;background:rgba(255,255,255,.07);margin-bottom:6px;cursor:pointer;}
.scan-res-item:active{background:rgba(201,168,76,.18);}
.scan-avatar{width:40px;height:40px;border-radius:50%;background:var(--gold);color:var(--navy);font-weight:800;font-size:16px;flex-shrink:0;display:flex;align-items:center;justify-content:center;}
.qr-box{width:100%;background:rgba(255,255,255,.07);border-radius:16px;padding:16px;display:none;}
.qr-box.visivel{display:block;}
.qr-box-titulo{color:var(--gold);font-size:11px;letter-spacing:2px;text-transform:uppercase;margin-bottom:6px;}
.qr-box-nome{color:#fff;font-size:20px;font-weight:800;margin-bottom:4px;}
.qr-box-sub{color:rgba(255,255,255,.5);font-size:13px;margin-bottom:12px;}
.qr-box-acoes{display:flex;gap:8px;}
#camera-wrap{display:none;flex-direction:column;align-items:center;background:var(--navy);gap:12px;width:100%;}
#camera-wrap.ativo{display:flex;}
#qr-video{width:100%;max-width:400px;border-radius:16px;background:#000;}
#qr-canvas{display:none;}

/* modais */
.modal-bg{position:fixed;inset:0;background:rgba(0,0,0,.55);z-index:500;display:none;align-items:flex-end;justify-content:center;}
.modal-bg.aberto{display:flex;}
.modal-caixa{background:#fff;border-radius:24px 24px 0 0;padding:24px;width:100%;max-width:480px;max-height:90vh;overflow-y:auto;animation:slideUp .25s ease;}
@keyframes slideUp{from{transform:translateY(100%);}to{transform:translateY(0);}}
.modal-handle{width:40px;height:4px;background:#dde;border-radius:2px;margin:0 auto 20px;}
.modal-titulo{font-family:'Playfair Display',serif;font-size:22px;font-weight:700;color:var(--navy);margin-bottom:18px;}

#toast{position:fixed;bottom:88px;left:50%;transform:translateX(-50%) translateY(16px);background:var(--navy);color:#fff;padding:12px 22px;border-radius:30px;font-size:14px;font-weight:600;z-index:600;opacity:0;transition:.3s;pointer-events:none;white-space:nowrap;}
#toast.visivel{opacity:1;transform:translateX(-50%) translateY(0);}

.recibo-pts{font-size:34px;font-weight:900;color:var(--green);margin-bottom:4px;}
.recibo-hint{background:#eef2f7;border-radius:14px;padding:12px;margin:14px 0;font-size:13px;color:var(--sea);}
.guia-passo{background:#eef2f7;border-radius:12px;padding:14px;margin-bottom:10px;}
.guia-num{width:28px;height:28px;border-radius:50%;background:var(--sea);color:#fff;font-weight:900;font-size:13px;display:flex;align-items:center;justify-content:center;flex-shrink:0;}

/* viewer */
#viewer-folheto{position:fixed;inset:0;z-index:800;background:#000;display:none;flex-direction:column;}
#viewer-folheto.aberto{display:flex;}
.viewer-topo{position:absolute;top:0;left:0;right:0;z-index:10;padding:16px;background:linear-gradient(to bottom,rgba(0,0,0,.7),transparent);display:flex;align-items:center;gap:12px;}
.viewer-contador{color:rgba(255,255,255,.7);font-size:13px;}
.viewer-track{display:flex;height:100vh;transition:transform .3s ease;}
.viewer-slide{flex-shrink:0;width:100vw;height:100vh;display:flex;align-items:center;justify-content:center;}
.viewer-slide img{max-width:100%;max-height:100%;object-fit:contain;}
.viewer-nav{position:absolute;top:50%;transform:translateY(-50%);background:rgba(255,255,255,.15);border:none;color:#fff;width:44px;height:44px;border-radius:50%;cursor:pointer;font-size:22px;display:flex;align-items:center;justify-content:center;}
.viewer-prev{left:12px;}.viewer-next{right:12px;}
</style>
</head>
<body>

<!-- PIN -->
<div id="ecra-pin">
  <div class="pin-titulo">MARINHA</div>
  <div class="pin-sub">Painel da Loja</div>
  <div class="pin-dots">
    <div class="pin-dot" id="d0"></div>
    <div class="pin-dot" id="d1"></div>
    <div class="pin-dot" id="d2"></div>
    <div class="pin-dot" id="d3"></div>
  </div>
  <div class="pin-erro" id="pin-erro"></div>
  <div class="pin-teclado">
    <button class="pin-btn" onclick="pinDigito('1')">1</button>
    <button class="pin-btn" onclick="pinDigito('2')">2</button>
    <button class="pin-btn" onclick="pinDigito('3')">3</button>
    <button class="pin-btn" onclick="pinDigito('4')">4</button>
    <button class="pin-btn" onclick="pinDigito('5')">5</button>
    <button class="pin-btn" onclick="pinDigito('6')">6</button>
    <button class="pin-btn" onclick="pinDigito('7')">7</button>
    <button class="pin-btn" onclick="pinDigito('8')">8</button>
    <button class="pin-btn" onclick="pinDigito('9')">9</button>
    <button class="pin-btn" onclick="pinDigito('*')" style="font-size:14px;color:rgba(255,255,255,.4);">‚öôÔ∏è</button>
    <button class="pin-btn" onclick="pinDigito('0')">0</button>
    <button class="pin-btn pin-btn-apagar" onclick="pinApagar()">‚å´</button>
  </div>
</div>

<!-- APP LOJA -->
<div id="app-loja">
  <header class="cabecalho">
    <button class="btn-back" onclick="sairAdmin()">
      <svg viewBox="0 0 24 24" fill="none" stroke-width="2.2" width="18" height="18"><path d="M19 12H5M12 5l-7 7 7 7"/></svg>
    </button>
    <div>
      <div class="cab-sub">Painel da Loja</div>
      <div class="cab-titulo" id="cab-loja-nome">MARINHA</div>
    </div>
  </header>

  <div class="ecra ativo" id="ecra-dash">
    <div class="hero-loja">
      <div class="hero-nome">Bem-vindo,</div>
      <div class="hero-loja-nome" id="dash-nome">A minha loja</div>
      <div class="stats-grid">
        <div class="stat-box"><div class="stat-val" id="stat-hoje">0</div><div class="stat-lbl">HOJE</div></div>
        <div class="stat-box"><div class="stat-val" id="stat-desc">0</div><div class="stat-lbl">DESCONTOS</div></div>
        <div class="stat-box"><div class="stat-val" id="stat-pts">0</div><div class="stat-lbl">PONTOS</div></div>
      </div>
    </div>
    <div class="secao">
      <div class="gap"></div>
      <div class="card">
        <div class="card-titulo">A√ß√µes r√°pidas</div>
        <div class="row" style="flex-wrap:wrap;">
          <button class="btn-s" onclick="irTab('scanner')" style="margin-bottom:10px;">üì∑ Ler QR</button>
          <button class="btn-s" onclick="abrirNovoCliente()" style="margin-bottom:10px;">‚ûï Novo cliente</button>
          <button class="btn-s" onclick="irTab('folheto')" style="margin-bottom:10px;">üìÑ Folheto</button>
          <button class="btn-s" onclick="irTab('clientes')" style="margin-bottom:10px;">üë• Clientes</button>
        </div>
      </div>
      <div class="card">
        <div class="card-titulo">√öltimas visitas</div>
        <div id="lista-recentes"><div style="text-align:center;padding:16px;color:var(--muted);font-size:14px;">Sem visitas hoje</div></div>
      </div>
    </div>
  </div>

  <div class="ecra" id="ecra-clientes">
    <div class="barra-pesquisa">
      <svg viewBox="0 0 24 24" fill="none" stroke="var(--muted)" stroke-width="2" width="18" height="18"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.35-4.35"/></svg>
      <input type="text" placeholder="Nome, telefone ou ID..." oninput="pesquisarClientes(this.value)" id="input-pesquisa">
      <span id="contagem-cli" style="color:var(--muted);font-size:12px;white-space:nowrap;"></span>
    </div>
    <div id="lista-clientes" style="background:#fff;min-height:100px;"></div>
    <div class="secao" style="padding-top:14px;">
      <button class="btn-p" onclick="abrirNovoCliente()">+ Novo cliente</button>
    </div>
  </div>

  <div class="ecra" id="ecra-folheto">
    <div class="secao">
      <div class="gap"></div>
      <div class="card">
        <div class="card-titulo">Folheto atual</div>
        <div class="folheto-strip" id="folheto-strip"><div style="color:var(--muted);font-size:13px;padding:10px 0;">Nenhum folheto carregado</div></div>
        <div class="row" style="margin-top:12px;">
          <button class="btn-p" onclick="document.getElementById('inp-folheto').click()">üìé Carregar</button>
          <button class="btn-s" id="btn-ver-fol" onclick="abrirViewer(0)" style="display:none;">üñºÔ∏è Ver</button>
        </div>
        <input type="file" id="inp-folheto" accept="image/*,.pdf" multiple style="display:none" onchange="carregarFolheto(event)">
      </div>
      <div class="card">
        <div class="card-titulo">Produtos em promo√ß√£o</div>
        <div id="lista-promos"><div style="text-align:center;padding:20px;color:var(--muted);">Sem promo√ß√µes</div></div>
        <button class="btn-p" style="margin-top:12px;" onclick="abrirNovaPromo()">+ Adicionar promo√ß√£o</button>
      </div>
    </div>
  </div>

  <div class="ecra" id="ecra-scanner">
    <div class="scan-wrap">
      <div id="camera-wrap">
        <div style="color:rgba(255,255,255,.5);font-size:12px;letter-spacing:2px;text-transform:uppercase;text-align:center;" id="camera-status">A iniciar c√¢mara...</div>
        <video id="qr-video" autoplay playsinline muted style="width:100%;max-width:400px;border-radius:16px;"></video>
        <canvas id="qr-canvas" style="display:none;"></canvas>
        <div class="row" style="width:100%;">
          <button class="btn-s" onclick="pararCamera()" style="color:#fff;background:rgba(255,255,255,.07);border-color:rgba(255,255,255,.12);">‚úï Parar</button>
          <button class="btn-s" onclick="inverterCamera()" style="color:#fff;background:rgba(255,255,255,.07);border-color:rgba(255,255,255,.12);">üîÑ Inverter</button>
        </div>
      </div>
      <div id="scan-principal" style="width:100%;display:flex;flex-direction:column;gap:14px;align-items:center;">
        <div class="scan-titulo">Scanner de Clientes</div>
        <div class="scan-sub">O cliente mostra o QR ‚Üí leia com a c√¢mara<br>ou pesquise manualmente abaixo</div>
        <button class="btn-camera" onclick="iniciarCamera()"><span style="font-size:24px;">üì∑</span> Ler QR com c√¢mara</button>
        <div class="sep-ou"><span>ou pesquise o cliente</span></div>
        <input type="text" class="campo-dark" id="inp-scan" placeholder="ID, nome ou telefone..." oninput="pesquisarScan(this.value)" autocomplete="off">
        <div class="scan-resultados" id="scan-resultados"></div>
        <div class="qr-box" id="qr-resultado">
          <div class="qr-box-titulo" id="qr-res-titulo">Cliente identificado</div>
          <div class="qr-box-nome" id="qr-res-nome">‚Äî</div>
          <div class="qr-box-sub" id="qr-res-sub">‚Äî</div>
          <div class="qr-box-acoes">
            <button id="qr-btn-compra" style="flex:1;padding:13px;background:linear-gradient(135deg,var(--gold),var(--gold-l));color:var(--navy);border:none;border-radius:12px;font-family:'DM Sans',sans-serif;font-weight:800;font-size:14px;cursor:pointer;">üí≥ Registar compra</button>
            <button onclick="fecharQRBox()" style="padding:13px 16px;background:rgba(255,255,255,.1);color:#fff;border:none;border-radius:12px;font-weight:600;cursor:pointer;font-family:'DM Sans',sans-serif;">‚úï</button>
          </div>
        </div>
        <button class="btn-s" onclick="abrirCompra(null)" style="width:100%;color:#fff;background:rgba(255,255,255,.05);border-color:rgba(255,255,255,.1);">üìù Registar sem QR</button>
        <button class="btn-s" onclick="document.getElementById('inp-qr-foto').click()" style="width:100%;color:#fff;background:rgba(255,255,255,.05);border-color:rgba(255,255,255,.1);">üñºÔ∏è Ler QR de foto</button>
        <input type="file" id="inp-qr-foto" accept="image/*" style="display:none" onchange="lerQRFoto(event)">
      </div>
    </div>
  </div>

  <div class="ecra" id="ecra-config">
    <div class="secao">
      <div class="gap"></div>
      <div class="card">
        <div class="card-titulo">Dados da loja</div>
        <label class="label">Nome da loja</label>
        <input type="text" class="campo" id="cfg-nome" placeholder="Ex: Mercearia MARINHA" oninput="guardarConfig()">
        <label class="label">Morada</label>
        <input type="text" class="campo" id="cfg-morada" placeholder="Rua, n√∫mero, localidade" oninput="guardarConfig()">
        <label class="label">Telefone</label>
        <input type="tel" class="campo" id="cfg-tel" placeholder="912 345 678" oninput="guardarConfig()">
      </div>
      <div class="card">
        <div class="card-titulo">Sistema de pontos</div>
        <label class="label">Pontos por euro gasto</label>
        <input type="number" class="campo" id="cfg-pts-euro" value="10" min="1" oninput="guardarConfig()">
        <label class="label">Pontos para 1‚Ç¨ de desconto</label>
        <input type="number" class="campo" id="cfg-pts-desc" value="100" min="1" oninput="guardarConfig()">
      </div>
      <div class="card">
        <div class="card-titulo">üîê Alterar PIN de acesso</div>
        <label class="label">PIN atual</label>
        <input type="password" class="campo" id="pin-atual" placeholder="PIN atual" maxlength="4" inputmode="numeric">
        <label class="label">Novo PIN (4 d√≠gitos)</label>
        <input type="password" class="campo" id="pin-novo" placeholder="Novo PIN" maxlength="4" inputmode="numeric">
        <button class="btn-s" onclick="alterarPIN()">Guardar novo PIN</button>
      </div>
      <div class="card">
        <div class="card-titulo">üì± Link da app para clientes</div>
        <div style="background:#eef2f7;border-radius:12px;padding:14px;font-size:13px;color:var(--muted);line-height:1.7;">
          Partilhe este link com os clientes:<br>
          <strong id="link-cliente" style="color:var(--sea);word-break:break-all;"></strong>
        </div>
        <button class="btn-s" style="margin-top:10px;" onclick="copiarLink()">üìã Copiar link</button>
        <div style="margin-top:14px;text-align:center;">
          <div style="background:var(--navy);border-radius:14px;padding:16px;display:inline-block;margin-bottom:8px;">
            <svg id="qr-partilha-svg" width="160" height="160" viewBox="0 0 160 160"></svg>
          </div>
          <div style="font-size:12px;color:var(--muted);">QR para imprimir e colocar na loja</div>
          <button onclick="imprimirQR()" class="btn-s" style="width:auto;padding:10px 20px;margin-top:8px;">üñ®Ô∏è Imprimir</button>
        </div>
      </div>
      <button class="btn-d" onclick="exportarDados()">üì§ Exportar dados</button>
      <div class="gap"></div>
    </div>
  </div>

  <nav class="navbar">
    <button class="nav-btn ativo" id="nl-dash" onclick="irTab('dash')">
      <svg viewBox="0 0 24 24"><rect x="3" y="3" width="7" height="7" rx="1"/><rect x="14" y="3" width="7" height="7" rx="1"/><rect x="3" y="14" width="7" height="7" rx="1"/><rect x="14" y="14" width="7" height="7" rx="1"/></svg>In√≠cio
    </button>
    <button class="nav-btn" id="nl-clientes" onclick="irTab('clientes')">
      <svg viewBox="0 0 24 24"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>Clientes
    </button>
    <button class="nav-btn" id="nl-folheto" onclick="irTab('folheto')">
      <svg viewBox="0 0 24 24"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/></svg>Folheto
    </button>
    <button class="nav-btn" id="nl-scanner" onclick="irTab('scanner')">
      <svg viewBox="0 0 24 24"><rect x="3" y="3" width="5" height="5"/><rect x="16" y="3" width="5" height="5"/><rect x="3" y="16" width="5" height="5"/><path d="M21 16h-3a2 2 0 0 0-2 2v3"/><path d="M21 21v.01"/><path d="M12 7v3a2 2 0 0 1-2 2H7"/><path d="M3 12h.01"/><path d="M12 3h.01"/><path d="M12 16v.01"/><path d="M16 12h1"/><path d="M21 12v.01"/><path d="M12 21v-1"/></svg>QR Scan
    </button>
    <button class="nav-btn" id="nl-config" onclick="irTab('config')">
      <svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1-2.83 2.83l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-4 0v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83-2.83l.06-.06A1.65 1.65 0 0 0 4.68 15a1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1 0-4h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 2.83-2.83l.06.06A1.65 1.65 0 0 0 9 4.68a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 4 0v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 2.83l-.06.06A1.65 1.65 0 0 0 19.4 9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 0 4h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg>Config
    </button>
  </nav>
</div>

<!-- MODAIS -->
<div class="modal-bg" id="modal-cli">
  <div class="modal-caixa">
    <div class="modal-handle"></div>
    <div class="modal-titulo" id="modal-cli-titulo">Novo Cliente</div>
    <input type="hidden" id="edit-cli-id">
    <label class="label">Nome completo *</label><input type="text" class="campo" id="mc-nome" placeholder="Nome do cliente">
    <label class="label">Telem√≥vel *</label><input type="tel" class="campo" id="mc-tel" placeholder="912 345 678">
    <label class="label">Email</label><input type="email" class="campo" id="mc-email" placeholder="email@exemplo.com">
    <label class="label">Observa√ß√µes</label><input type="text" class="campo" id="mc-obs" placeholder="Notas opcionais">
    <div class="row">
      <button class="btn-p" onclick="guardarCliente()">Guardar</button>
      <button class="btn-s" style="flex:0 0 auto;width:auto;padding:15px 18px;" onclick="fecharModal('modal-cli')">Cancelar</button>
    </div>
    <div style="margin-top:10px;display:none;" id="wrap-apagar-cli">
      <button class="btn-d" onclick="apagarClienteOk()">Apagar cliente</button>
    </div>
  </div>
</div>

<div class="modal-bg" id="modal-promo">
  <div class="modal-caixa">
    <div class="modal-handle"></div>
    <div class="modal-titulo" id="modal-promo-titulo">Nova Promo√ß√£o</div>
    <input type="hidden" id="edit-promo-id">
    <label class="label">Nome do produto *</label><input type="text" class="campo" id="mp-nome" placeholder="Ex: Queijo Curado">
    <label class="label">Descri√ß√£o</label><input type="text" class="campo" id="mp-desc" placeholder="Ex: Serra da Estrela ¬∑ 250g">
    <label class="label">Foto do produto</label>
    <div style="display:flex;align-items:center;gap:12px;margin-bottom:10px;">
      <div id="mp-foto-prev" style="width:64px;height:64px;border-radius:12px;background:#eef2f7;border:1.5px dashed rgba(26,74,138,.25);display:flex;align-items:center;justify-content:center;font-size:28px;overflow:hidden;">üõí</div>
      <button class="btn-s" style="flex:1;" onclick="document.getElementById('inp-foto-promo').click()">üì∑ Carregar foto</button>
      <input type="file" id="inp-foto-promo" accept="image/*" style="display:none" onchange="previewFotoPromo(event)">
    </div>
    <label class="label">Emoji (sem foto)</label><input type="text" class="campo" id="mp-emoji" placeholder="üßÄ" maxlength="2">
    <div class="row">
      <div><label class="label">Pre√ßo original (‚Ç¨)</label><input type="number" class="campo" id="mp-preco-orig" placeholder="5.90" step="0.01"></div>
      <div><label class="label">Pre√ßo promo (‚Ç¨)</label><input type="number" class="campo" id="mp-preco-novo" placeholder="4.10" step="0.01"></div>
    </div>
    <div class="row">
      <div><label class="label">Data in√≠cio</label><input type="date" class="campo" id="mp-data-ini"></div>
      <div><label class="label">Data fim</label><input type="date" class="campo" id="mp-data-fim"></div>
    </div>
    <div class="row">
      <button class="btn-p" onclick="guardarPromo()">Guardar</button>
      <button class="btn-s" style="flex:0 0 auto;width:auto;padding:15px 18px;" onclick="fecharModal('modal-promo')">Cancelar</button>
    </div>
    <div style="margin-top:10px;display:none;" id="wrap-apagar-promo">
      <button class="btn-d" onclick="apagarPromoOk()">Apagar promo√ß√£o</button>
    </div>
  </div>
</div>

<div class="modal-bg" id="modal-compra">
  <div class="modal-caixa">
    <div class="modal-handle"></div>
    <div class="modal-titulo">Registar Compra</div>
    <label class="label">Cliente</label>
    <select class="campo" id="rc-cliente" onchange="atualizarInfoCompra()"><option value="">Selecionar cliente...</option></select>
    <label class="label">Valor da compra (‚Ç¨)</label>
    <input type="number" class="campo" id="rc-valor" placeholder="0.00" step="0.01" oninput="calcPts()">
    <div id="rc-preview" style="display:none;background:#eef2f7;border-radius:12px;padding:12px;margin-bottom:10px;text-align:center;">
      <span style="font-size:16px;font-weight:700;color:var(--navy);" id="rc-pts-prev">+0 pontos</span>
    </div>
    <div id="rc-desc-info" style="margin-bottom:12px;"></div>
    <div class="row">
      <button class="btn-p" onclick="confirmarCompra()">‚úì Confirmar</button>
      <button class="btn-s" style="flex:0 0 auto;width:auto;padding:15px 18px;" onclick="fecharModal('modal-compra')">Cancelar</button>
    </div>
  </div>
</div>

<div class="modal-bg" id="modal-recibo">
  <div class="modal-caixa" style="text-align:center;">
    <div class="modal-handle"></div>
    <div style="font-size:11px;font-weight:700;color:var(--muted);letter-spacing:1.5px;text-transform:uppercase;margin-bottom:6px;">RECIBO DIGITAL</div>
    <div class="modal-titulo" id="recibo-nome" style="margin-bottom:4px;">Cliente</div>
    <div class="recibo-pts" id="recibo-pts">+0 pontos</div>
    <div style="font-size:14px;color:var(--muted);margin-bottom:4px;" id="recibo-total"></div>
    <div style="font-size:13px;color:var(--gold);font-weight:700;margin-bottom:4px;" id="recibo-desc"></div>
    <div style="font-size:12px;color:var(--muted);margin-bottom:16px;" id="recibo-valor"></div>
    <div style="background:var(--navy);border-radius:16px;padding:18px;display:inline-block;margin-bottom:14px;">
      <svg id="qr-recibo-svg" width="180" height="180" viewBox="0 0 180 180"></svg>
    </div>
    <div class="recibo-hint">üì± Cliente l√™ este QR com a app ‚Üí QR ‚Üí Ler recibo</div>
    <button class="btn-p" onclick="fecharModal('modal-recibo')">‚úì Fechar</button>
  </div>
</div>

<div class="modal-bg" id="modal-detalhe">
  <div class="modal-caixa"><div class="modal-handle"></div><div id="detalhe-conteudo"></div></div>
</div>

<div id="viewer-folheto">
  <div class="viewer-topo">
    <button class="btn-back" onclick="fecharViewer()"><svg viewBox="0 0 24 24" fill="none" stroke-width="2.2" width="18" height="18"><path d="M19 12H5M12 5l-7 7 7 7"/></svg></button>
    <div class="viewer-contador" id="viewer-count">1 / 1</div>
  </div>
  <div id="viewer-track" class="viewer-track"></div>
  <button class="viewer-nav viewer-prev" onclick="navViewer(-1)">‚Äπ</button>
  <button class="viewer-nav viewer-next" onclick="navViewer(1)">‚Ä∫</button>
</div>

<div id="toast"></div>

<script>
// ‚îÄ‚îÄ PIN ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
var PIN_DEFAULT = '1234';
var _pinAtual = '';

function getPIN() { return localStorage.getItem('MARINHA_PIN') || PIN_DEFAULT; }

function pinDigito(d) {
  if (d === '*') return; // reservado
  if (_pinAtual.length >= 4) return;
  _pinAtual += d;
  atualizarDots();
  if (_pinAtual.length === 4) {
    setTimeout(verificarPIN, 150);
  }
}

function pinApagar() {
  _pinAtual = _pinAtual.slice(0, -1);
  atualizarDots();
  document.getElementById('pin-erro').textContent = '';
}

function atualizarDots() {
  for (var i = 0; i < 4; i++) {
    document.getElementById('d' + i).classList.toggle('preenchido', i < _pinAtual.length);
  }
}

function verificarPIN() {
  if (_pinAtual === getPIN()) {
    document.getElementById('ecra-pin').style.display = 'none';
    document.getElementById('app-loja').classList.add('visivel');
    irTab('dash');
    carregarImagens();
  } else {
    document.getElementById('pin-erro').textContent = 'PIN incorreto. Tente novamente.';
    _pinAtual = '';
    atualizarDots();
  }
}

function alterarPIN() {
  var atual = document.getElementById('pin-atual').value;
  var novo  = document.getElementById('pin-novo').value;
  if (atual !== getPIN()) { toast('‚ö†Ô∏è PIN atual incorreto'); return; }
  if (!/^\d{4}$/.test(novo)) { toast('‚ö†Ô∏è O novo PIN deve ter 4 d√≠gitos'); return; }
  localStorage.setItem('MARINHA_PIN', novo);
  document.getElementById('pin-atual').value = '';
  document.getElementById('pin-novo').value  = '';
  toast('‚úÖ PIN alterado com sucesso');
}

function sairAdmin() {
  if (!confirm('Sair do painel?')) return;
  document.getElementById('ecra-pin').style.display = '';
  document.getElementById('app-loja').classList.remove('visivel');
  _pinAtual = '';
  atualizarDots();
  document.getElementById('pin-erro').textContent = '';
}

// ‚îÄ‚îÄ BASE DE DADOS (partilhada com index.html via localStorage) ‚îÄ‚îÄ
var DB = {
  clientes: [], promos: [], folhetos: [], visitas: [], clienteLogado: null,
  config: { nomeLoja:'', morada:'', tel:'', ptsEuro:10, ptsDesc:100, appUrl:'' }
};

var _idb = null;
function abrirIDB() {
  return new Promise(function(res,rej){
    if(_idb) return res(_idb);
    var r=indexedDB.open('MARINHA_V2',1);
    r.onupgradeneeded=function(e){e.target.result.createObjectStore('imgs');};
    r.onsuccess=function(e){_idb=e.target.result;res(_idb);};
    r.onerror=function(){rej(r.error);};
  });
}
function idbPut(k,v){return abrirIDB().then(function(db){return new Promise(function(res,rej){var tx=db.transaction('imgs','readwrite');tx.objectStore('imgs').put(v,k);tx.oncomplete=res;tx.onerror=function(){rej(tx.error);};});});}
function idbGet(k){return abrirIDB().then(function(db){return new Promise(function(res,rej){var tx=db.transaction('imgs','readonly');var r=tx.objectStore('imgs').get(k);r.onsuccess=function(){res(r.result);};r.onerror=function(){rej(r.error);};});});}
function idbDel(k){return abrirIDB().then(function(db){return new Promise(function(res,rej){var tx=db.transaction('imgs','readwrite');tx.objectStore('imgs').delete(k);tx.oncomplete=res;tx.onerror=function(){rej(tx.error);};});});}
function idbKeys(){return abrirIDB().then(function(db){return new Promise(function(res,rej){var tx=db.transaction('imgs','readonly');var r=tx.objectStore('imgs').getAllKeys();r.onsuccess=function(){res(r.result);};r.onerror=function(){rej(r.error);};});});}

function guardarDB(){
  // Guardar fotos das promos no IndexedDB (n√£o no localStorage)
  DB.promos.forEach(function(p){
    if(p.foto&&p.foto.length>100){
      idbPut('P_'+p.id,p.foto).catch(function(){});
    }
  });
  // Guardar folhetos no IndexedDB
  DB.folhetos.forEach(function(f){if(f.data)idbPut('F_'+f.id,f.data).catch(function(){});});
  // Guardar texto no localStorage (sem fotos base64 grandes)
  try{
    var copia={
      clientes:DB.clientes,
      promos:DB.promos.map(function(p){return{id:p.id,nome:p.nome,desc:p.desc,emoji:p.emoji,temFoto:!!(p.foto&&p.foto.length>100),precoOrig:p.precoOrig,precoNovo:p.precoNovo,dataIni:p.dataIni,dataFim:p.dataFim};}),
      folhetos:DB.folhetos.map(function(f){return{id:f.id,nome:f.nome,tipo:f.tipo,adicionado:f.adicionado};}),
      visitas:DB.visitas,
      clienteLogado:DB.clienteLogado,
      config:DB.config
    };
    localStorage.setItem('MARINHA_V2',JSON.stringify(copia));
  }catch(e){toast('‚ö†Ô∏è Erro ao guardar: '+e.message);}
  // Limpar IDB de promos apagadas
  idbKeys().then(function(ks){
    ks.filter(function(k){return k.indexOf('P_')===0&&!DB.promos.find(function(p){return'P_'+p.id===k;});}).forEach(function(k){idbDel(k).catch(function(){});});
    ks.filter(function(k){return k.indexOf('F_')===0&&!DB.folhetos.find(function(f){return'F_'+f.id===k;});}).forEach(function(k){idbDel(k).catch(function(){});});
  }).catch(function(){});
}

function carregarDB(){
  var s=localStorage.getItem('MARINHA_V2'); if(!s) return;
  var d=JSON.parse(s);
  if(d.clientes)DB.clientes=d.clientes;
  if(d.promos)DB.promos=d.promos;
  if(d.folhetos)DB.folhetos=d.folhetos;
  if(d.visitas)DB.visitas=d.visitas;
  if(d.clienteLogado)DB.clienteLogado=d.clienteLogado;
  if(d.config)DB.config=Object.assign({},DB.config,d.config);
}

function carregarImagens(){
  DB.folhetos.forEach(function(f,i){
    if(!f.data){idbGet('F_'+f.id).then(function(data){if(data){DB.folhetos[i]=Object.assign({},DB.folhetos[i],{data:data});renderFolheto();}}).catch(function(){});}
  });
  DB.promos.forEach(function(p,i){
    if(p.temFoto&&!p.foto){idbGet('P_'+p.id).then(function(data){if(data){DB.promos[i]=Object.assign({},DB.promos[i],{foto:data});renderPromos();}}).catch(function(){});}
  });
}

carregarDB();

// ‚îÄ‚îÄ UTILIT√ÅRIOS ‚îÄ‚îÄ
function uid(){return Date.now().toString(36)+Math.random().toString(36).substr(2,5);}
function hoje(){return new Date().toISOString().split('T')[0];}
function formatarData(d){if(!d)return'‚Äî';return new Date(d).toLocaleDateString('pt-PT',{day:'2-digit',month:'short',year:'numeric'});}
function toast(msg,dur){dur=dur||2500;var t=document.getElementById('toast');t.textContent=msg;t.classList.add('visivel');setTimeout(function(){t.classList.remove('visivel');},dur);}
function fecharModal(id){document.getElementById(id).classList.remove('aberto');}
function getNivel(pts){if(pts>=2000)return{label:'üíé Diamante'};if(pts>=1000)return{label:'ü•á Ouro'};if(pts>=500)return{label:'ü•à Prata'};return{label:'ü•â Bronze'};}
function calcDesc(pts){return Math.floor(pts/DB.config.ptsDesc);}
function promosAtivas(){var h=hoje();return DB.promos.filter(function(p){return(!p.dataIni||p.dataIni<=h)&&(!p.dataFim||p.dataFim>=h);});}

// ‚îÄ‚îÄ NAV ‚îÄ‚îÄ
function irTab(tab){
  pararCamera();
  var ecras=document.querySelectorAll('#app-loja .ecra');
  for(var i=0;i<ecras.length;i++)ecras[i].classList.remove('ativo');
  var btns=document.querySelectorAll('.navbar .nav-btn');
  for(var i=0;i<btns.length;i++)btns[i].classList.remove('ativo');
  document.getElementById('ecra-'+tab).classList.add('ativo');
  var btn=document.getElementById('nl-'+tab);
  if(btn)btn.classList.add('ativo');
  if(tab==='dash')renderDash();
  if(tab==='clientes')renderClientes('');
  if(tab==='folheto'){renderFolheto();renderPromos();carregarImagens();}
  if(tab==='config')carregarConfig();
  window.scrollTo(0,0);
}

// ‚îÄ‚îÄ DASHBOARD ‚îÄ‚îÄ
function renderDash(){
  var nome=DB.config.nomeLoja||'A minha loja';
  document.getElementById('dash-nome').textContent=nome;
  document.getElementById('cab-loja-nome').textContent=nome;
  var h=hoje();
  var vh=DB.visitas.filter(function(v){return v.data.indexOf(h)===0;});
  document.getElementById('stat-hoje').textContent=vh.length;
  document.getElementById('stat-desc').textContent=vh.filter(function(v){return v.desconto>0;}).length;
  document.getElementById('stat-pts').textContent=vh.reduce(function(a,v){return a+(v.pts||0);},0);
  var rec=DB.visitas.slice().sort(function(a,b){return b.data.localeCompare(a.data);}).slice(0,5);
  var el=document.getElementById('lista-recentes');
  if(!rec.length){el.innerHTML='<div style="text-align:center;padding:16px;color:var(--muted);font-size:14px;">Sem visitas hoje</div>';return;}
  el.innerHTML=rec.map(function(v){
    var c=DB.clientes.find(function(x){return x.id===v.clienteId;});
    var hora=new Date(v.data).toLocaleTimeString('pt-PT',{hour:'2-digit',minute:'2-digit'});
    return'<div style="display:flex;align-items:center;gap:10px;padding:10px 0;border-bottom:1px solid rgba(0,0,0,.05);"><div class="avatar" style="width:36px;height:36px;font-size:15px;">'+(c?c.nome.charAt(0).toUpperCase():'?')+'</div><div style="flex:1;"><div style="font-size:14px;font-weight:700;">'+(c?c.nome:'Desconhecido')+'</div><div style="font-size:11px;color:var(--muted);">+'+(v.pts||0)+' pts ¬∑ '+(v.valor?v.valor.toFixed(2)+'‚Ç¨':'')+'</div></div><div style="font-size:11px;color:var(--muted);">'+hora+'</div></div>';
  }).join('');
}

// ‚îÄ‚îÄ CLIENTES ‚îÄ‚îÄ
function renderClientes(filtro){
  filtro=(filtro||'').toLowerCase();
  var lista=DB.clientes.filter(function(c){return c.nome.toLowerCase().indexOf(filtro)>=0||(c.tel||'').indexOf(filtro)>=0||(c.id||'').slice(-6).toLowerCase().indexOf(filtro)>=0;});
  document.getElementById('contagem-cli').textContent=lista.length+' cliente'+(lista.length!==1?'s':'');
  var el=document.getElementById('lista-clientes');
  if(!lista.length){el.innerHTML='<div style="text-align:center;padding:30px;color:var(--muted);">Nenhum cliente encontrado</div>';return;}
  el.innerHTML=lista.map(function(c){
    var n=getNivel(c.pts||0);
    return'<div class="cli-row" onclick="abrirDetalhe(\''+c.id+'\')"><div class="avatar">'+c.nome.charAt(0).toUpperCase()+'</div><div style="flex:1;"><div style="font-size:15px;font-weight:700;">'+c.nome+'</div><div style="font-size:12px;color:var(--muted);">'+(c.tel||'')+' ¬∑ <span style="color:var(--gold);font-family:monospace;font-size:11px;">ID:'+(c.id||'').slice(-6).toUpperCase()+'</span></div><div style="font-size:11px;color:var(--muted);">'+n.label+'</div></div><div><div class="cli-pts-val">'+(c.pts||0)+'</div><div class="cli-pts-lbl">pts</div></div></div>';
  }).join('');
}
function pesquisarClientes(v){renderClientes(v);}

function abrirDetalhe(id){
  var c=DB.clientes.find(function(x){return x.id===id;});if(!c)return;
  var n=getNivel(c.pts||0),d=calcDesc(c.pts||0),id6=(c.id||'').slice(-6).toUpperCase();
  var hist=(c.historico||[]).slice(0,8).map(function(h){return'<div style="display:flex;align-items:center;gap:12px;padding:12px 0;border-bottom:1px solid rgba(0,0,0,.05);"><div style="font-size:20px;">'+(h.desconto>0?'üí∞':'‚≠ê')+'</div><div style="flex:1;"><div style="font-size:14px;font-weight:600;">'+h.desc+'</div><div style="font-size:11px;color:var(--muted);">'+formatarData(h.data)+'</div></div><div style="font-size:14px;font-weight:700;color:var(--green);">+'+h.pts+' pts</div></div>';}).join('')||'<div style="color:var(--muted);font-size:13px;">Sem hist√≥rico</div>';
  document.getElementById('detalhe-conteudo').innerHTML=
    '<div style="display:flex;align-items:center;gap:14px;margin-bottom:16px;"><div class="avatar" style="width:56px;height:56px;font-size:22px;">'+c.nome.charAt(0).toUpperCase()+'</div><div><div style="font-size:20px;font-weight:700;">'+c.nome+'</div><div style="font-size:12px;color:var(--muted);">'+(c.tel||'')+' ¬∑ '+n.label+'</div><div style="font-size:11px;color:var(--gold);font-family:monospace;">ID: '+id6+'</div></div></div>'+
    '<div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px;margin-bottom:16px;"><div style="background:#eef2f7;border-radius:12px;padding:12px;text-align:center;"><div style="font-size:20px;font-weight:800;color:var(--navy);">'+(c.pts||0)+'</div><div style="font-size:10px;color:var(--muted);">PONTOS</div></div><div style="background:#eef2f7;border-radius:12px;padding:12px;text-align:center;"><div style="font-size:20px;font-weight:800;color:var(--navy);">'+(c.visitas||0)+'</div><div style="font-size:10px;color:var(--muted);">VISITAS</div></div><div style="background:#eef2f7;border-radius:12px;padding:12px;text-align:center;"><div style="font-size:20px;font-weight:800;color:var(--green);">'+(d>0?d.toFixed(2)+'‚Ç¨':'‚Äî')+'</div><div style="font-size:10px;color:var(--muted);">DESCONTO</div></div></div>'+
    '<div style="display:flex;gap:8px;margin-bottom:14px;"><button class="btn-p" onclick="fecharModal(\'modal-detalhe\');abrirCompra(\''+c.id+'\')">üí≥ Registar compra</button><button class="btn-s" style="flex:0 0 auto;width:auto;padding:15px 14px;" onclick="abrirEditarCliente(\''+c.id+'\')">‚úèÔ∏è</button></div>'+
    '<div style="font-size:11px;font-weight:700;color:var(--muted);letter-spacing:1px;text-transform:uppercase;margin-bottom:10px;">Hist√≥rico</div>'+hist;
  document.getElementById('modal-detalhe').classList.add('aberto');
}

function abrirNovoCliente(){
  document.getElementById('edit-cli-id').value='';
  document.getElementById('modal-cli-titulo').textContent='Novo Cliente';
  ['mc-nome','mc-tel','mc-email','mc-obs'].forEach(function(id){document.getElementById(id).value='';});
  document.getElementById('wrap-apagar-cli').style.display='none';
  document.getElementById('modal-cli').classList.add('aberto');
}
function abrirEditarCliente(id){
  var c=DB.clientes.find(function(x){return x.id===id;});if(!c)return;
  fecharModal('modal-detalhe');
  document.getElementById('edit-cli-id').value=c.id;
  document.getElementById('modal-cli-titulo').textContent='Editar Cliente';
  document.getElementById('mc-nome').value=c.nome||'';
  document.getElementById('mc-tel').value=c.tel||'';
  document.getElementById('mc-email').value=c.email||'';
  document.getElementById('mc-obs').value=c.obs||'';
  document.getElementById('wrap-apagar-cli').style.display='block';
  document.getElementById('modal-cli').classList.add('aberto');
}
function guardarCliente(){
  var id=document.getElementById('edit-cli-id').value;
  var nome=document.getElementById('mc-nome').value.trim();
  var tel=document.getElementById('mc-tel').value.trim();
  if(!nome||!tel){toast('‚ö†Ô∏è Nome e telem√≥vel obrigat√≥rios');return;}
  if(id){var c=DB.clientes.find(function(x){return x.id===id;});if(c){c.nome=nome;c.tel=tel;c.email=document.getElementById('mc-email').value;c.obs=document.getElementById('mc-obs').value;}}
  else{DB.clientes.push({id:uid(),nome:nome,tel:tel,email:document.getElementById('mc-email').value,obs:document.getElementById('mc-obs').value,pts:0,visitas:0,carimbos:0,poupado:0,desde:hoje(),historico:[]});}
  guardarDB();fecharModal('modal-cli');renderClientes(document.getElementById('input-pesquisa').value);
  toast(id?'‚úÖ Cliente atualizado':'‚úÖ Cliente adicionado');
}
function apagarClienteOk(){
  var id=document.getElementById('edit-cli-id').value;
  if(!confirm('Apagar este cliente?'))return;
  DB.clientes=DB.clientes.filter(function(x){return x.id!==id;});
  guardarDB();fecharModal('modal-cli');renderClientes('');toast('üóëÔ∏è Cliente removido');
}

// ‚îÄ‚îÄ FOLHETO ‚îÄ‚îÄ
function carregarFolheto(e){
  var files=Array.prototype.slice.call(e.target.files);if(!files.length)return;
  toast('‚è≥ A carregar '+files.length+' ficheiro(s)...');
  var loaded=0;
  files.forEach(function(f){
    var r=new FileReader();
    r.onload=function(ev){
      DB.folhetos.push({id:uid(),nome:f.name,tipo:f.type,data:ev.target.result,adicionado:hoje()});
      loaded++;if(loaded===files.length){guardarDB();renderFolheto();toast('‚úÖ '+files.length+' p√°gina(s) carregada(s)!');try{e.target.value='';}catch(x){}}
    };r.readAsDataURL(f);
  });
}
function renderFolheto(){
  var el=document.getElementById('folheto-strip');
  var temImgs=DB.folhetos.some(function(f){return f.tipo&&f.tipo.indexOf('image/')===0&&f.data;});
  var btnVer=document.getElementById('btn-ver-fol');if(btnVer)btnVer.style.display=temImgs?'':'none';
  if(!DB.folhetos.length){el.innerHTML='<div style="color:var(--muted);font-size:13px;padding:10px 0;">Nenhum folheto carregado</div>';return;}
  el.innerHTML=DB.folhetos.map(function(f,i){var isImg=f.tipo&&f.tipo.indexOf('image/')===0;return'<div class="fol-thumb" onclick="abrirViewer('+i+')">'+(isImg&&f.data?'<img src="'+f.data+'" alt="pg '+(i+1)+'">':(isImg?'üñºÔ∏è':'üìÑ'))+'</div>';}).join('');
}
function previewFotoPromo(e){
  var f=e.target.files[0];if(!f)return;
  var r=new FileReader();
  r.onload=function(ev){var prev=document.getElementById('mp-foto-prev');prev.innerHTML='<img src="'+ev.target.result+'" style="width:100%;height:100%;object-fit:cover;">';prev.dataset.foto=ev.target.result;try{e.target.value='';}catch(x){}};
  r.readAsDataURL(f);
}
function renderPromos(){
  var el=document.getElementById('lista-promos');
  if(!DB.promos.length){el.innerHTML='<div style="text-align:center;padding:20px;color:var(--muted);">Sem promo√ß√µes adicionadas</div>';return;}
  var h=hoje();
  el.innerHTML='<div class="promos-grid">'+DB.promos.map(function(p){
    var ativa=(!p.dataIni||p.dataIni<=h)&&(!p.dataFim||p.dataFim>=h);
    var pct=p.precoOrig>0?Math.round((1-p.precoNovo/p.precoOrig)*100):0;
    return'<div class="promo-card" onclick="editarPromo(\''+p.id+'\')"><div class="promo-img">'+(p.foto?'<img src="'+p.foto+'">':(p.emoji||'üõí'))+(!ativa?'<div style="position:absolute;top:6px;right:6px;background:rgba(0,0,0,.6);color:#fff;font-size:10px;padding:2px 6px;border-radius:6px;">Inativa</div>':'')+(pct>0?'<div class="badge-desc">-'+pct+'%</div>':'')+'</div><div class="promo-body"><div class="promo-nome">'+p.nome+'</div>'+(p.desc?'<div class="promo-sub">'+p.desc+'</div>':'')+'<div class="preco-linha">'+(p.precoOrig?'<span class="preco-orig">'+parseFloat(p.precoOrig).toFixed(2)+'‚Ç¨</span>':'')+(p.precoNovo?'<span class="preco-novo">'+parseFloat(p.precoNovo).toFixed(2)+'‚Ç¨</span>':'')+'</div></div></div>';
  }).join('')+'</div>';
}
function abrirNovaPromo(){
  document.getElementById('edit-promo-id').value='';
  document.getElementById('modal-promo-titulo').textContent='Nova Promo√ß√£o';
  ['mp-nome','mp-desc','mp-emoji','mp-preco-orig','mp-preco-novo','mp-data-fim'].forEach(function(id){document.getElementById(id).value='';});
  document.getElementById('mp-data-ini').value=hoje();
  var prev=document.getElementById('mp-foto-prev');prev.innerHTML='üõí';prev.dataset.foto='';
  document.getElementById('wrap-apagar-promo').style.display='none';
  document.getElementById('modal-promo').classList.add('aberto');
}
function editarPromo(id){
  var p=DB.promos.find(function(x){return x.id===id;});if(!p)return;
  document.getElementById('edit-promo-id').value=p.id;
  document.getElementById('modal-promo-titulo').textContent='Editar Promo√ß√£o';
  document.getElementById('mp-nome').value=p.nome||'';document.getElementById('mp-desc').value=p.desc||'';
  document.getElementById('mp-emoji').value=p.emoji||'';document.getElementById('mp-preco-orig').value=p.precoOrig||'';
  document.getElementById('mp-preco-novo').value=p.precoNovo||'';document.getElementById('mp-data-ini').value=p.dataIni||'';
  document.getElementById('mp-data-fim').value=p.dataFim||'';
  var prev=document.getElementById('mp-foto-prev');prev.innerHTML=p.foto?'<img src="'+p.foto+'" style="width:100%;height:100%;object-fit:cover;">':'üõí';prev.dataset.foto=p.foto||'';
  document.getElementById('wrap-apagar-promo').style.display='block';
  document.getElementById('modal-promo').classList.add('aberto');
}
function guardarPromo(){
  var id=document.getElementById('edit-promo-id').value;
  var nome=document.getElementById('mp-nome').value.trim();if(!nome){toast('‚ö†Ô∏è Nome obrigat√≥rio');return;}
  var dados={nome:nome,desc:document.getElementById('mp-desc').value,emoji:document.getElementById('mp-emoji').value,foto:document.getElementById('mp-foto-prev').dataset.foto||'',precoOrig:document.getElementById('mp-preco-orig').value,precoNovo:document.getElementById('mp-preco-novo').value,dataIni:document.getElementById('mp-data-ini').value,dataFim:document.getElementById('mp-data-fim').value};
  if(id){var p=DB.promos.find(function(x){return x.id===id;});if(p)Object.assign(p,dados);}
  else{dados.id=uid();DB.promos.push(dados);}
  guardarDB();fecharModal('modal-promo');renderPromos();toast(id?'‚úÖ Promo√ß√£o atualizada':'‚úÖ Promo√ß√£o adicionada');
}
function apagarPromoOk(){
  var id=document.getElementById('edit-promo-id').value;if(!confirm('Apagar esta promo√ß√£o?'))return;
  DB.promos=DB.promos.filter(function(x){return x.id!==id;});
  guardarDB();fecharModal('modal-promo');renderPromos();toast('üóëÔ∏è Promo√ß√£o removida');
}

// ‚îÄ‚îÄ VIEWER ‚îÄ‚îÄ
var _vi=0,_vit=[],_tsx=0;
function abrirViewer(idx){_vit=DB.folhetos.filter(function(f){return f.tipo&&f.tipo.indexOf('image/')===0&&f.data;});if(!_vit.length){toast('Sem imagens');return;}_vi=Math.max(0,Math.min(idx,_vit.length-1));var track=document.getElementById('viewer-track');track.innerHTML=_vit.map(function(f){return'<div class="viewer-slide"><img src="'+f.data+'" alt=""></div>';}).join('');atualizarViewer();document.getElementById('viewer-folheto').classList.add('aberto');track.addEventListener('touchstart',function(e){_tsx=e.touches[0].clientX;},{passive:true});track.addEventListener('touchend',function(e){var dx=e.changedTouches[0].clientX-_tsx;if(Math.abs(dx)>40)navViewer(dx<0?1:-1);});}
function atualizarViewer(){document.getElementById('viewer-track').style.transform='translateX(-'+(_vi*100)+'vw)';document.getElementById('viewer-count').textContent=(_vi+1)+' / '+_vit.length;}
function navViewer(dir){_vi=Math.max(0,Math.min(_vit.length-1,_vi+dir));atualizarViewer();}
function fecharViewer(){document.getElementById('viewer-folheto').classList.remove('aberto');}

// ‚îÄ‚îÄ SCANNER ‚îÄ‚îÄ
var _stream=null,_face='environment',_scanInt=null,_det=null;
function iniciarCamera(){
  var ok=location.protocol==='https:'||location.hostname==='localhost';
  if(!ok||!navigator.mediaDevices){toast('‚ö†Ô∏è C√¢mara s√≥ funciona em HTTPS.',4000);return;}
  if(window.BarcodeDetector&&!_det){BarcodeDetector.getSupportedFormats().then(function(f){_det=new BarcodeDetector({formats:f.indexOf('qr_code')>=0?['qr_code']:f});}).catch(function(){});}
  document.getElementById('scan-principal').style.display='none';
  var cw=document.getElementById('camera-wrap');cw.classList.add('ativo');
  document.getElementById('camera-status').textContent='A aceder √† c√¢mara...';
  navigator.mediaDevices.getUserMedia({video:{facingMode:_face,width:{ideal:1280}},audio:false})
    .then(function(stream){_stream=stream;var v=document.getElementById('qr-video');v.srcObject=stream;v.play();v.onloadedmetadata=function(){document.getElementById('camera-status').textContent=window.BarcodeDetector?'‚úÖ Aponte para o QR':'‚ö†Ô∏è Browser sem leitura auto';if(window.BarcodeDetector)iniciarLeitura();};})
    .catch(function(err){document.getElementById('camera-status').textContent='‚ö†Ô∏è '+(err.name==='NotAllowedError'?'Permiss√£o negada.':'C√¢mara n√£o encontrada.');});
}
function iniciarLeitura(){var v=document.getElementById('qr-video'),cd=false;_scanInt=setInterval(function(){if(v.readyState<2||!_det)return;_det.detect(v).then(function(cs){if(cs.length&&!cd){cd=true;setTimeout(function(){cd=false;},3000);processarQR(cs[0].rawValue);}}).catch(function(){});},400);}
function inverterCamera(){_face=_face==='environment'?'user':'environment';pararCamera();iniciarCamera();}
function pararCamera(){clearInterval(_scanInt);_scanInt=null;if(_stream){_stream.getTracks().forEach(function(t){t.stop();});_stream=null;}var v=document.getElementById('qr-video');if(v)v.srcObject=null;var cw=document.getElementById('camera-wrap');if(cw)cw.classList.remove('ativo');var sp=document.getElementById('scan-principal');if(sp)sp.style.display='flex';}
function lerQRFoto(e){var f=e.target.files[0];if(!f)return;toast('‚è≥ A ler QR...');var img=new Image(),url=URL.createObjectURL(f);img.onload=function(){var cv=document.createElement('canvas');cv.width=img.width;cv.height=img.height;cv.getContext('2d').drawImage(img,0,0);URL.revokeObjectURL(url);try{e.target.value='';}catch(x){}if(window.BarcodeDetector){var d=new BarcodeDetector({formats:['qr_code']});d.detect(cv).then(function(cs){if(cs.length)processarQR(cs[0].rawValue);else toast('‚ö†Ô∏è N√£o foi poss√≠vel ler o QR.',3500);}).catch(function(){toast('‚ö†Ô∏è Erro.',3500);});}else toast('‚ö†Ô∏è Browser sem suporte.',3500);};img.src=url;}
function pesquisarScan(q){var el=document.getElementById('scan-resultados');if(!q||q.length<2){el.innerHTML='';return;}var fl=q.toLowerCase();var lista=DB.clientes.filter(function(c){return c.nome.toLowerCase().indexOf(fl)>=0||(c.tel||'').indexOf(q)>=0||(c.id||'').slice(-6).toLowerCase().indexOf(fl)>=0;}).slice(0,6);if(!lista.length){el.innerHTML='<div style="color:rgba(255,255,255,.4);font-size:13px;padding:10px;">Nenhum cliente encontrado</div>';return;}el.innerHTML=lista.map(function(c){var n=getNivel(c.pts||0),d=calcDesc(c.pts||0);return'<div class="scan-res-item" onclick="selecionarCliScan(\''+c.id+'\')"><div class="scan-avatar">'+c.nome.charAt(0).toUpperCase()+'</div><div style="flex:1;"><div style="color:#fff;font-weight:700;font-size:14px;">'+c.nome+'</div><div style="color:rgba(255,255,255,.4);font-size:11px;">'+(c.pts||0)+' pts ¬∑ '+n.label+'</div></div>'+(d>0?'<div style="color:var(--green);font-size:12px;font-weight:700;">'+d.toFixed(2)+'‚Ç¨</div>':'')+'</div>';}).join('');}
function selecionarCliScan(id){document.getElementById('inp-scan').value='';document.getElementById('scan-resultados').innerHTML='';processarQR('MARINHA:ID:'+id);}
function processarQR(texto){if(navigator.vibrate)navigator.vibrate(100);pararCamera();var cli=null;var m=texto.match(/MARINHA:ID:([^:]+)/i);if(m)cli=DB.clientes.find(function(c){return c.id===m[1];});if(!cli){var t=texto.trim();cli=DB.clientes.find(function(c){return c.id===t||(c.id||'').slice(-6).toUpperCase()===t.toUpperCase();});}if(!cli){var tm=texto.match(/(\d{9})/);if(tm)cli=DB.clientes.find(function(c){return(c.tel||'').replace(/\s/g,'')===tm[1];});}var box=document.getElementById('qr-resultado');if(cli){var d=calcDesc(cli.pts||0),n=getNivel(cli.pts||0);document.getElementById('qr-res-titulo').textContent='‚úÖ Cliente identificado';document.getElementById('qr-res-nome').textContent=cli.nome;document.getElementById('qr-res-sub').textContent=(cli.pts||0)+' pontos ¬∑ '+n.label+(d>0?' ¬∑ üí∞ '+d.toFixed(2)+'‚Ç¨':'');var cid=cli.id;document.getElementById('qr-btn-compra').onclick=function(){fecharQRBox();abrirCompra(cid);};}else{document.getElementById('qr-res-titulo').textContent='‚ùì N√£o reconhecido';document.getElementById('qr-res-nome').textContent='QR desconhecido';document.getElementById('qr-res-sub').textContent='Registe manualmente';document.getElementById('qr-btn-compra').onclick=function(){fecharQRBox();abrirCompra(null);};}box.classList.add('visivel');}
function fecharQRBox(){document.getElementById('qr-resultado').classList.remove('visivel');}

// ‚îÄ‚îÄ COMPRA ‚îÄ‚îÄ
function abrirCompra(cliId){var sel=document.getElementById('rc-cliente');sel.innerHTML='<option value="">Selecionar cliente...</option>';DB.clientes.forEach(function(c){var o=document.createElement('option');o.value=c.id;o.textContent=c.nome+' ('+(c.pts||0)+' pts)';sel.appendChild(o);});if(cliId)sel.value=cliId;document.getElementById('rc-valor').value='';document.getElementById('rc-preview').style.display='none';document.getElementById('rc-desc-info').innerHTML='';atualizarInfoCompra();document.getElementById('modal-compra').classList.add('aberto');}
function atualizarInfoCompra(){var id=document.getElementById('rc-cliente').value,c=DB.clientes.find(function(x){return x.id===id;}),el=document.getElementById('rc-desc-info');if(!c){el.innerHTML='';return;}var d=calcDesc(c.pts||0);el.innerHTML=d>0?'<div style="display:flex;align-items:center;gap:10px;background:rgba(39,174,96,.1);border-radius:12px;padding:12px;"><div style="font-size:22px;">üí∞</div><div><div style="font-weight:700;color:var(--green);">'+d.toFixed(2)+'‚Ç¨ dispon√≠veis</div><div style="font-size:12px;color:var(--muted);">Aplicado ao confirmar</div></div></div>':'<div style="font-size:13px;color:var(--muted);">Sem desconto ('+(c.pts||0)+'/'+DB.config.ptsDesc+' pts)</div>';calcPts();}
function calcPts(){var val=parseFloat(document.getElementById('rc-valor').value)||0,pts=Math.floor(val*DB.config.ptsEuro),prev=document.getElementById('rc-preview');if(val>0){prev.style.display='block';document.getElementById('rc-pts-prev').textContent='+'+pts+' pontos';}else prev.style.display='none';}
function confirmarCompra(){
  var cliId=document.getElementById('rc-cliente').value,valor=parseFloat(document.getElementById('rc-valor').value)||0;
  if(!cliId){toast('‚ö†Ô∏è Selecione um cliente');return;}if(valor<=0){toast('‚ö†Ô∏è Insira o valor');return;}
  var c=DB.clientes.find(function(x){return x.id===cliId;});if(!c)return;
  var ptsG=Math.floor(valor*DB.config.ptsEuro),dD=calcDesc(c.pts||0),ptsU=dD>0?dD*DB.config.ptsDesc:0;
  c.pts=(c.pts||0)+ptsG-ptsU;c.visitas=(c.visitas||0)+1;c.poupado=(c.poupado||0)+dD;
  if(ptsG>=50)c.carimbos=(c.carimbos||0)+1;
  if(!c.historico)c.historico=[];
  c.historico.unshift({tipo:'compra',desc:'Compra de '+valor.toFixed(2)+'‚Ç¨',pts:ptsG,desconto:dD,data:new Date().toISOString()});
  DB.visitas.push({id:uid(),clienteId:cliId,valor:valor,pts:ptsG,desconto:dD,data:new Date().toISOString()});
  guardarDB();fecharModal('modal-compra');renderDash();renderClientes('');
  if(navigator.vibrate)navigator.vibrate([100,50,100]);
  mostrarRecibo(c,valor,ptsG,dD);
}
function mostrarRecibo(c,valor,pts,desc){
  var payload='MARINHA:UPDATE:'+c.id+':'+(c.pts||0)+':'+(c.visitas||0)+':'+(c.poupado||0).toFixed(2);
  document.getElementById('recibo-nome').textContent=c.nome;
  document.getElementById('recibo-pts').textContent='+'+pts+' pontos ganhos';
  document.getElementById('recibo-total').textContent='Total: '+(c.pts||0)+' pontos';
  document.getElementById('recibo-desc').textContent=desc>0?'üí∞ Desconto aplicado: '+desc.toFixed(2)+'‚Ç¨':'';
  document.getElementById('recibo-valor').textContent='Compra: '+valor.toFixed(2)+'‚Ç¨';
  desenharQR(payload,document.getElementById('qr-recibo-svg'));
  document.getElementById('modal-recibo').classList.add('aberto');
}

// ‚îÄ‚îÄ CONFIG ‚îÄ‚îÄ
function carregarConfig(){
  var cfg=DB.config;
  document.getElementById('cfg-nome').value=cfg.nomeLoja||'';
  document.getElementById('cfg-morada').value=cfg.morada||'';
  document.getElementById('cfg-tel').value=cfg.tel||'';
  document.getElementById('cfg-pts-euro').value=cfg.ptsEuro||10;
  document.getElementById('cfg-pts-desc').value=cfg.ptsDesc||100;
  var linkEl=document.getElementById('link-cliente');
  var url=window.location.origin+window.location.pathname.replace(/admin\.html$/,'').replace(/\/$/,'')+'/index.html';
  if(linkEl){linkEl.textContent=url;desenharQR(url,document.getElementById('qr-partilha-svg'));}
}
function guardarConfig(){
  DB.config.nomeLoja=document.getElementById('cfg-nome').value;
  DB.config.morada=document.getElementById('cfg-morada').value;
  DB.config.tel=document.getElementById('cfg-tel').value;
  DB.config.ptsEuro=parseInt(document.getElementById('cfg-pts-euro').value)||10;
  DB.config.ptsDesc=parseInt(document.getElementById('cfg-pts-desc').value)||100;
  guardarDB();
  document.getElementById('cab-loja-nome').textContent=DB.config.nomeLoja||'MARINHA';
  document.getElementById('dash-nome').textContent=DB.config.nomeLoja||'A minha loja';
}
function copiarLink(){
  var url=window.location.origin+window.location.pathname.replace(/admin\.html$/,'').replace(/\/$/,'')+'/index.html';
  navigator.clipboard.writeText(url).then(function(){toast('‚úÖ Link copiado!');}).catch(function(){toast('Link: '+url,4000);});
}
function imprimirQR(){
  var url=window.location.origin+window.location.pathname.replace(/admin\.html$/,'').replace(/\/$/,'')+'/index.html';
  var svg=document.getElementById('qr-partilha-svg');
  var nome=DB.config.nomeLoja||'MARINHA';
  var w=window.open('','_blank');
  w.document.write('<!DOCTYPE html><html><head><meta charset="UTF-8"><style>body{margin:0;padding:40px;font-family:sans-serif;text-align:center;}h1{font-size:36px;color:#0a1628;}.qr{background:#0a1628;border-radius:20px;padding:24px;display:inline-block;margin:20px 0;}</style></head><body><h1>‚öì '+nome+'</h1><p>Programa de fideliza√ß√£o digital</p><div class="qr">'+svg.outerHTML+'</div><p>üì± Aponte a c√¢mara para entrar na app</p><p style="font-size:12px;color:#999;">'+url+'</p><script>window.onload=function(){window.print()}<\/script></body></html>');
  w.document.close();
}
function exportarDados(){
  var b=new Blob([JSON.stringify(DB,null,2)],{type:'application/json'});
  var a=document.createElement('a');a.href=URL.createObjectURL(b);a.download='marinha_backup_'+hoje()+'.json';a.click();
  toast('üì§ Dados exportados');
}

// ‚îÄ‚îÄ QR GENERATOR ‚îÄ‚îÄ
function desenharQR(texto,svgEl){
  if(!svgEl)return;
  var size=parseInt(svgEl.getAttribute('width'))||160;
  var mat=_gerarMatriz(texto),n=mat.length,cell=size/n;
  var isBgDark=svgEl.id==='qr-recibo-svg';
  var bgC=isBgDark?'#0a1628':'#ffffff',modC=isBgDark?'#ffffff':'#0a1628';
  var html='<rect width="'+size+'" height="'+size+'" fill="'+bgC+'"/>';
  for(var r=0;r<n;r++)for(var c=0;c<n;c++){if(mat[r][c])html+='<rect x="'+(c*cell).toFixed(1)+'" y="'+(r*cell).toFixed(1)+'" width="'+(cell+.3).toFixed(1)+'" height="'+(cell+.3).toFixed(1)+'" fill="'+modC+'"/>';}
  svgEl.innerHTML=html;
}
function _gerarMatriz(texto){
  var bytes=[];
  for(var i=0;i<texto.length;i++){var code=texto.charCodeAt(i);if(code<128){bytes.push(code);}else if(code<2048){bytes.push(0xC0|(code>>6));bytes.push(0x80|(code&63));}else{bytes.push(0xE0|(code>>12));bytes.push(0x80|((code>>6)&63));bytes.push(0x80|(code&63));}}
  var ver=2;if(bytes.length>14)ver=3;if(bytes.length>26)ver=4;if(bytes.length>42)ver=5;if(bytes.length>60)ver=6;if(bytes.length>84)ver=7;if(bytes.length>110)ver=9;
  return _buildMatrix(bytes,ver);
}
function _buildMatrix(dados,ver){
  var n=17+ver*4,m=[],func=[];
  for(var i=0;i<n;i++){m[i]=[];func[i]=[];for(var j=0;j<n;j++){m[i][j]=false;func[i][j]=false;}}
  function sf(r,c,v){if(r>=0&&r<n&&c>=0&&c<n){m[r][c]=v;func[r][c]=true;}}
  function finder(tr,tc){for(var r=-1;r<=7;r++)for(var c=-1;c<=7;c++){var v=(r>=0&&r<7&&c>=0&&c<7)&&(r===0||r===6||c===0||c===6||(r>=2&&r<=4&&c>=2&&c<=4));sf(tr+r,tc+c,v);}}
  finder(0,0);finder(0,n-7);finder(n-7,0);
  for(var i=8;i<n-8;i++){sf(6,i,i%2===0);sf(i,6,i%2===0);}
  sf(4*ver+9,8,true);
  var alPos={2:[6,18],3:[6,22],4:[6,26],5:[6,30],6:[6,34],7:[6,22,38],9:[6,26,46]}[ver]||[];
  for(var ai=0;ai<alPos.length;ai++)for(var aj=0;aj<alPos.length;aj++){var ar=alPos[ai],ac=alPos[aj];if(!func[ar][ac]){for(var dr=-2;dr<=2;dr++)for(var dc=-2;dc<=2;dc++)sf(ar+dr,ac+dc,dr===0&&dc===0||Math.abs(dr)===2||Math.abs(dc)===2);}}
  var caps={2:28,3:44,4:64,5:86,6:108,7:124,9:154};var cap=caps[ver]||44;
  var stream=[0x04,dados.length];for(var i=0;i<dados.length;i++)stream.push(dados[i]);
  var pad=[0xEC,0x11];while(stream.length<cap)stream.push(pad[(stream.length-2-dados.length)%2]);
  var bits=[];for(var i=0;i<stream.length;i++)for(var b=7;b>=0;b--)bits.push((stream[i]>>b)&1);
  var bi=0,goUp=true;
  for(var col=n-1;col>=1;col-=2){if(col<=6)col--;for(var row=goUp?n-1:0;goUp?row>=0:row<n;row+=goUp?-1:1){for(var dc2=0;dc2<2;dc2++){var c2=col-dc2;if(!func[row][c2])m[row][c2]=bi<bits.length?bits[bi++]===1:false;}}goUp=!goUp;}
  for(var r=0;r<n;r++)for(var c=0;c<n;c++){if(!func[r][c]&&(r+c)%2===0)m[r][c]=!m[r][c];}
  return m;
}

document.addEventListener('click',function(e){if(e.target.classList.contains('modal-bg'))e.target.classList.remove('aberto');});
</script>
</body>
</html>
