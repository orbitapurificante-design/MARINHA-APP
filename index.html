<!DOCTYPE html>
<html lang="pt">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
<meta name="theme-color" content="#0a1628">
<title>MARINHA ‚Äì Fideliza√ß√£o</title>
<link rel="manifest" href="manifest.json">
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700&family=DM+Sans:wght@400;600;700;800&display=swap" rel="stylesheet">
<style>
*{box-sizing:border-box;margin:0;padding:0;-webkit-tap-highlight-color:transparent}
:root{--n:#0a1628;--s:#1a4a8a;--g:#c9a84c;--gl:#e8c97a;--bg:#f4f1ec;--mu:#7a8a9a;--gr:#27ae60;--r:#e74c3c;--cr:#f5f0e8}
body{font-family:'DM Sans',sans-serif;background:var(--bg);color:var(--n);min-height:100vh}

/* REGISTO */
#eReg{position:fixed;inset:0;z-index:100;background:linear-gradient(160deg,var(--n),var(--s));display:flex;flex-direction:column;align-items:center;justify-content:center;padding:32px;gap:16px}
.rT{font-family:'Playfair Display',serif;font-size:40px;color:var(--cr);letter-spacing:6px}
.rS{color:var(--g);font-size:11px;letter-spacing:3px;text-transform:uppercase}
.rInp{width:100%;padding:14px 16px;background:rgba(255,255,255,.1);border:1.5px solid rgba(255,255,255,.2);border-radius:14px;color:#fff;font-size:18px;font-family:'DM Sans',sans-serif;outline:none;text-align:center;letter-spacing:2px}
.rInp::placeholder{color:rgba(255,255,255,.3);letter-spacing:1px}
.rBtn{width:100%;padding:15px;background:linear-gradient(135deg,var(--g),var(--gl));color:var(--n);border:none;border-radius:14px;font-weight:800;font-size:16px;cursor:pointer;font-family:'DM Sans',sans-serif}
.rNote{color:rgba(255,255,255,.4);font-size:12px;text-align:center;line-height:1.5}

/* APP */
#eApp{display:none;flex-direction:column;min-height:100vh}
#eApp.v{display:flex}
.cab{position:fixed;top:0;left:0;right:0;z-index:100;height:60px;background:linear-gradient(135deg,var(--n),var(--s));display:flex;align-items:center;gap:12px;padding:0 16px;box-shadow:0 3px 16px rgba(0,0,0,.25)}
.cabT{color:#fff;font-size:16px;font-weight:700;flex:1}
.cabS{color:rgba(255,255,255,.45);font-size:10px;letter-spacing:2px;text-transform:uppercase}
.nav{position:fixed;bottom:0;left:0;right:0;z-index:100;background:#fff;border-top:1px solid rgba(0,0,0,.07);display:flex;height:68px}
.nBtn{flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:3px;border:none;background:none;cursor:pointer;font-size:10px;font-weight:700;letter-spacing:.5px;text-transform:uppercase;color:var(--mu);font-family:'DM Sans',sans-serif}
.nBtn svg{width:22px;height:22px;stroke:currentColor;fill:none;stroke-width:1.8}
.nBtn.a{color:var(--n)}.nBtn.a svg{stroke:var(--g)}
.ecra{display:none;padding:72px 0 80px}.ecra.a{display:block}
.s{padding:0 16px}
.card{background:#fff;border-radius:16px;padding:16px;box-shadow:0 2px 12px rgba(10,22,40,.06);margin-bottom:14px}
.ct{font-size:11px;font-weight:700;color:var(--mu);letter-spacing:1.5px;text-transform:uppercase;margin-bottom:12px}

/* INICIO */
.hero{background:linear-gradient(135deg,var(--n),var(--s));border-radius:20px;padding:24px;color:#fff;margin-bottom:14px;position:relative;overflow:hidden}
.hNome{font-size:22px;font-weight:800;margin-bottom:2px}
.hSub{color:rgba(255,255,255,.5);font-size:12px;margin-bottom:20px}
.hGrid{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:16px}
.hItem{background:rgba(255,255,255,.08);border-radius:12px;padding:12px;text-align:center}
.hVal{font-size:22px;font-weight:800}
.hLbl{font-size:10px;color:rgba(255,255,255,.5);margin-top:2px}
.barraW{background:rgba(255,255,255,.15);border-radius:6px;height:8px;margin-bottom:6px;overflow:hidden}
.barraI{height:100%;background:linear-gradient(90deg,var(--g),var(--gl));border-radius:6px;transition:.5s}
.nivelRow{display:flex;justify-content:space-between;font-size:11px;color:rgba(255,255,255,.5)}

/* QR */
.qrBox{background:linear-gradient(160deg,var(--n),var(--s));border-radius:20px;padding:24px;text-align:center;margin-bottom:14px}
.qrNum{font-family:'Playfair Display',serif;font-size:28px;color:var(--g);letter-spacing:4px;margin-bottom:4px}
.qrSub{color:rgba(255,255,255,.4);font-size:11px;letter-spacing:2px;text-transform:uppercase;margin-bottom:16px}
.qrSvgW{background:var(--n);border-radius:16px;padding:16px;display:inline-block;margin-bottom:12px}

/* PROMOS */
.promoG{display:grid;grid-template-columns:1fr 1fr;gap:10px}
.pc{background:#fff;border-radius:14px;overflow:hidden;box-shadow:0 2px 10px rgba(10,22,40,.07)}
.pi{width:100%;aspect-ratio:1;background:#eef2f7;overflow:hidden}
.pi img{position:absolute;top:0;left:0;width:100%;height:100%;object-fit:cover;display:block}
.bdg{position:absolute;top:6px;left:6px;background:var(--r);color:#fff;font-size:10px;font-weight:700;padding:2px 6px;border-radius:6px}
.pb{padding:10px}.pn{font-size:13px;font-weight:700;margin-bottom:4px}
.po{font-size:11px;color:var(--mu);text-decoration:line-through}
.pv{font-size:15px;font-weight:800;color:var(--r)}

/* FOLHETO */
.fStrip{display:flex;gap:10px;overflow-x:auto;padding:4px 0 8px;scrollbar-width:none}.fStrip::-webkit-scrollbar{display:none}
.fTh{flex-shrink:0;width:90px;height:120px;border-radius:10px;overflow:hidden;cursor:pointer;background:#eef2f7}
.fTh img{width:100%;height:100%;object-fit:cover}

/* VIEWER */
.viewer{display:none;position:fixed;inset:0;z-index:800;background:#000;flex-direction:column}
.viewer.a{display:flex}
.vTrack{display:flex;transition:transform .3s;height:100%}
.vSlide{flex-shrink:0;width:100vw;display:flex;align-items:center;justify-content:center}
.vSlide img{width:100%;height:100%;object-fit:contain}
.vTop{position:absolute;top:0;left:0;right:0;padding:14px;background:linear-gradient(rgba(0,0,0,.6),transparent);display:flex;align-items:center;gap:10px;z-index:10}
.vBtn{padding:8px 14px;background:rgba(255,255,255,.15);border:none;color:#fff;border-radius:8px;cursor:pointer;font-family:'DM Sans',sans-serif;font-size:14px}

#toast{position:fixed;bottom:80px;left:50%;transform:translateX(-50%) translateY(8px);background:var(--n);color:#fff;padding:10px 20px;border-radius:24px;font-size:14px;font-weight:600;z-index:9999;opacity:0;transition:.2s;pointer-events:none;white-space:nowrap}
#toast.v{opacity:1;transform:translateX(-50%) translateY(0)}
</style>
</head>
<script>
  if ('serviceWorker' in navigator) {
    caches.keys().then(function(k){k.forEach(function(n){caches.delete(n);});});
    navigator.serviceWorker.register('./sw.js');
  }
</script>
<body>

<!-- REGISTO -->
<div id="eReg">
  <div class="rT">MARINHA</div>
  <div class="rS">Cart√£o de Fideliza√ß√£o</div>
  <div style="width:100%;max-width:340px;display:flex;flex-direction:column;gap:12px">
    <input class="rInp" id="rNome" type="text" placeholder="O seu nome" autocomplete="name">
    <input class="rInp" id="rTel" type="tel" placeholder="Telem√≥vel (9XX XXX XXX)" autocomplete="tel">
    <button class="rBtn" onclick="registar()">Entrar ‚Üí</button>
  </div>
  <div class="rNote">O seu cart√£o fica guardado neste dispositivo.<br>N√£o precisa de instalar nada.</div>
</div>

<!-- APP -->
<div id="eApp">
  <div class="cab">
    <div>
      <div class="cabT" id="cabNome">MARINHA</div>
      <div class="cabS">Fideliza√ß√£o</div>
    </div>
  </div>

  <!-- INICIO -->
  <div class="ecra a" id="ecraInicio">
    <div class="s">
      <div style="height:10px"></div>
      <div class="hero">
        <div class="hNome" id="hNome">Ol√°!</div>
        <div class="hSub" id="hNum">N¬∫ ‚Äî</div>
        <div class="hGrid">
          <div class="hItem"><div class="hVal" id="hPts">0</div><div class="hLbl">PONTOS</div></div>
          <div class="hItem"><div class="hVal" id="hPou">0‚Ç¨</div><div class="hLbl">POUPADO</div></div>
          <div class="hItem"><div class="hVal" id="hVis">0</div><div class="hLbl">VISITAS</div></div>
          <div class="hItem"><div class="hVal" id="hDesc" style="color:var(--g)">0‚Ç¨</div><div class="hLbl">DESCONTO</div></div>
        </div>
        <div class="barraW"><div class="barraI" id="hBarra" style="width:0%"></div></div>
        <div class="nivelRow"><span id="hNivel">Bronze</span><span id="hProx"></span></div>
      </div>
      <div class="card" id="promosCard" style="display:none">
        <div class="ct">Promo√ß√µes activas</div>
        <div id="hPromos"></div>
      </div>
    </div>
  </div>

  <!-- QR -->
  <div class="ecra" id="ecraQR">
    <div class="s">
      <div style="height:10px"></div>
      <div class="qrBox">
        <div class="qrNum" id="qrNum">N¬∫ ‚Äî</div>
        <div class="qrSub">Mostre ao comerciante</div>
        <div class="qrSvgW">
          <svg id="qrSvg" width="180" height="180" viewBox="0 0 180 180"></svg>
        </div>
        <div style="color:rgba(255,255,255,.5);font-size:12px" id="qrNome"></div>
      </div>
    </div>
  </div>

  <!-- FOLHETO -->
  <div class="ecra" id="ecraFolheto">
    <div class="s">
      <div style="height:10px"></div>
      <div class="card">
        <div class="ct">Promo√ß√µes</div>
        <div id="fPromos"><div style="color:var(--mu);font-size:14px;padding:8px 0">A carregar...</div></div>
      </div>
      <div id="fFolheto"></div>
    </div>
  </div>

  <!-- PERFIL -->
  <div class="ecra" id="ecraPerfil">
    <div class="s">
      <div style="height:10px"></div>
      <div class="card">
        <div class="ct">A minha conta</div>
        <div id="pInfo"></div>
      </div>
      <button style="width:100%;padding:13px;background:rgba(231,76,60,.07);color:var(--r);border:1.5px solid rgba(231,76,60,.2);border-radius:14px;font-weight:700;font-size:14px;cursor:pointer;font-family:'DM Sans',sans-serif" onclick="sair()">Sair / Mudar conta</button>
    </div>
  </div>

  <nav class="nav">
    <button class="nBtn a" id="nInicio" onclick="irTab('Inicio')">
      <svg viewBox="0 0 24 24"><path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>Inicio
    </button>
    <button class="nBtn" id="nQR" onclick="irTab('QR')">
      <svg viewBox="0 0 24 24"><rect x="3" y="3" width="5" height="5"/><rect x="16" y="3" width="5" height="5"/><rect x="3" y="16" width="5" height="5"/><path d="M21 16h-3a2 2 0 0 0-2 2v3M21 21v.01M12 7v3a2 2 0 0 1-2 2H7"/></svg>QR
    </button>
    <button class="nBtn" id="nFolheto" onclick="irTab('Folheto')">
      <svg viewBox="0 0 24 24"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/></svg>Promos
    </button>
    <button class="nBtn" id="nPerfil" onclick="irTab('Perfil')">
      <svg viewBox="0 0 24 24"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>Perfil
    </button>
  </nav>
</div>

<!-- VIEWER -->
<div class="viewer" id="viewer">
  <div class="vTop">
    <button class="vBtn" onclick="fecharV()">‚Üê Fechar</button>
    <span style="color:rgba(255,255,255,.6);font-size:13px" id="vCount"></span>
    <div style="flex:1"></div>
    <button class="vBtn" onclick="navV(-1)">‚Äπ</button>
    <button class="vBtn" onclick="navV(1)">‚Ä∫</button>
  </div>
  <div class="vTrack" id="vTrack"></div>
</div>

<div id="toast"></div>

<script>
var SB='https://opzmuzogxfzeqwjxmfvc.supabase.co';
var SK='sb_publishable_e_Bd_rx2rfzBeIrbyGxCwA_SfXklv4s';
function hd(){return{'apikey':SK,'Authorization':'Bearer '+SK,'Content-Type':'application/json'};}

async function sbGet(t,q){
  try{
    var r=await fetch(SB+'/rest/v1/'+t+'?select=*'+(q?'&'+q:''),{headers:hd()});
    return r.ok?await r.json():[];
  }catch(e){return[];}
}
async function sbUp(t,d){
  try{
    var r=await fetch(SB+'/rest/v1/'+t,{
      method:'POST',
      headers:Object.assign({},hd(),{'Prefer':'resolution=merge-duplicates'}),
      body:JSON.stringify(Array.isArray(d)?d:[d])
    });
    return r.ok;
  }catch(e){return false;}
}

// IndexedDB para cache de imagens grandes
var _idb=null;
function abrirIDB(){
  return new Promise(function(res,rej){
    if(_idb)return res(_idb);
    var r=indexedDB.open('MARINHA_IDX',1);
    r.onupgradeneeded=function(e){e.target.result.createObjectStore('imgs');};
    r.onsuccess=function(e){_idb=e.target.result;res(_idb);};
    r.onerror=function(){rej();};
  });
}
function idbGet(k){
  return abrirIDB().then(function(db){
    return new Promise(function(res){
      var tx=db.transaction('imgs','readonly');
      var req=tx.objectStore('imgs').get(k);
      req.onsuccess=function(){res(req.result||null);};
      req.onerror=function(){res(null);};
    });
  }).catch(function(){return null;});
}

var D={eu:null,promos:[],folhetos:[],cfg:{ptsEuro:10,ptsDesc:100}};

function uid(){return Date.now().toString(36)+Math.random().toString(36).slice(2,5);}
function hoje(){return new Date().toISOString().slice(0,10);}
function fd(d){return d?new Date(d).toLocaleDateString('pt-PT',{day:'2-digit',month:'short'}):'‚Äî';}
function nivel(p){return p>=2000?'üíé Diamante':p>=1000?'ü•á Ouro':p>=500?'ü•à Prata':'ü•â Bronze';}
function proxNivel(p){return p>=2000?{v:2000,l:'N√≠vel m√°ximo!'}:p>=1000?{v:2000,l:'‚Üí Diamante'}:p>=500?{v:1000,l:'‚Üí Ouro'}:{v:500,l:'‚Üí Prata'};}
function descEur(p){return Math.floor((p||0)/(D.cfg.ptsDesc||100));}
function ativas(){
  var h=hoje();
  return D.promos.filter(function(p){return(!p.data_ini||p.data_ini<=h)&&(!p.data_fim||p.data_fim>=h);});
}

function toast(m,ms){
  var t=document.getElementById('toast');
  t.textContent=m;t.classList.add('v');
  clearTimeout(t._t);
  t._t=setTimeout(function(){t.classList.remove('v');},ms||2500);
}

async function sincronizar(){
  var r=await Promise.all([
    sbGet('promos'),
    sbGet('folhetos'),
    sbGet('config','id=eq.1')
  ]);
  if(Array.isArray(r[0])){
    D.promos=r[0];
    console.log('Promos recebidas:',r[0].length);
    r[0].forEach(function(p){console.log(' -',p.nome,'foto:',(p.foto?p.foto.slice(0,50)+'...':'SEM FOTO'));});
  }
  if(Array.isArray(r[1])){
    D.folhetos=r[1];
    console.log('Folhetos recebidos:',r[1].length);
    // Para folhetos sem data no Supabase, tentar IDB local
    r[1].forEach(function(f,i){
      if(!f.data||f.data===''){
        idbGet('F_'+f.id).then(function(d){
          if(d){D.folhetos[i].data=d;renderFolheto();}
        });
      }
    });
  }
  if(r[2]&&r[2][0]){D.cfg.ptsEuro=r[2][0].pts_euro||10;D.cfg.ptsDesc=r[2][0].pts_desc||100;}
}

// ‚îÄ‚îÄ NAV ‚îÄ‚îÄ
var _tab='Inicio';
function irTab(tab){
  _tab=tab;
  document.querySelectorAll('.ecra').forEach(function(e){e.classList.remove('a');});
  document.querySelectorAll('.nBtn').forEach(function(e){e.classList.remove('a');});
  document.getElementById('ecra'+tab).classList.add('a');
  document.getElementById('n'+tab).classList.add('a');
  if(tab==='Inicio')renderInicio();
  if(tab==='QR')renderQR();
  if(tab==='Folheto')renderFolheto();
  if(tab==='Perfil')renderPerfil();
  window.scrollTo(0,0);
}

// ‚îÄ‚îÄ RENDERS ‚îÄ‚îÄ
function renderInicio(){
  var c=D.eu;if(!c)return;
  document.getElementById('hNome').textContent='Ol√°, '+c.nome.split(' ')[0]+'!';
  document.getElementById('hNum').textContent='N¬∫ '+(c.num_cliente||'‚Äî');
  document.getElementById('hPts').textContent=c.pts||0;
  document.getElementById('hPou').textContent=parseFloat(c.poupado||0).toFixed(2)+'‚Ç¨';
  document.getElementById('hVis').textContent=c.visitas||0;
  var d=descEur(c.pts||0);
  document.getElementById('hDesc').textContent=d>0?d.toFixed(2)+'‚Ç¨':'0‚Ç¨';
  var n=nivel(c.pts||0),p=proxNivel(c.pts||0);
  document.getElementById('hBarra').style.width=Math.min(100,((c.pts||0)/p.v)*100)+'%';
  document.getElementById('hNivel').textContent=n;
  document.getElementById('hProx').textContent=p.l;
  // Promos preview
  var av=ativas().slice(0,2);
  var el=document.getElementById('promosCard');
  if(av.length){
    el.style.display='block';
    document.getElementById('hPromos').innerHTML=av.map(function(p){
      var img=p.foto?'<img src="'+p.foto+'" style="width:44px;height:44px;border-radius:10px;object-fit:cover;flex-shrink:0">':'<div style="width:44px;height:44px;border-radius:10px;background:#eef2f7;display:flex;align-items:center;justify-content:center;font-size:22px;flex-shrink:0">'+(p.emoji||'üõí')+'</div>';
      var pn=parseFloat(p.preco_novo)||0;
      return '<div style="display:flex;align-items:center;gap:12px;padding:8px 0;border-bottom:1px solid rgba(0,0,0,.05)">'+img+'<div style="flex:1"><div style="font-size:14px;font-weight:600">'+p.nome+'</div><div style="font-size:11px;color:var(--mu)">at√© '+fd(p.data_fim)+'</div></div>'+(pn>0?'<div style="font-size:16px;font-weight:800;color:var(--r)">'+pn.toFixed(2)+'‚Ç¨</div>':'')+'</div>';
    }).join('');
  } else { el.style.display='none'; }
}

function renderQR(){
  var c=D.eu;if(!c)return;
  document.getElementById('qrNum').textContent='N¬∫ '+(c.num_cliente||'‚Äî');
  document.getElementById('qrNome').textContent=c.nome;
  qrDraw('MARINHA:ID:'+c.id,document.getElementById('qrSvg'),true);
}

function renderFolheto(){
  var av=ativas();
  // Promo√ß√µes
  document.getElementById('fPromos').innerHTML=av.length?
    '<div class="promoG">'+av.map(function(p){
      var po=parseFloat(p.preco_orig)||0,pn=parseFloat(p.preco_novo)||0;
      var pct=(po>0&&pn>0)?Math.round((1-pn/po)*100):0;
      var piStyle='width:100%;height:150px;background:#eef2f7;overflow:hidden;display:block;position:relative';
      return '<div class="pc">'+
        '<div style="'+piStyle+'">'+(p.foto?'<img id="pi_'+p.id+'" src="" style="width:100%;height:100%;object-fit:cover;display:block">':(p.emoji||'üõí'))+(pct>0?'<span class="bdg">-'+pct+'%</span>':'')+
        '</div><div class="pb"><div class="pn">'+p.nome+'</div><div style="display:flex;align-items:center;gap:4px">'+
        (po>0?'<span class="po">'+po.toFixed(2)+'‚Ç¨</span>':'')+
        (pn>0?'<span class="pv">'+pn.toFixed(2)+'‚Ç¨</span>':'')+
        '</div></div></div>';
    }).join('')+'</div>':
    '<div style="color:var(--mu);font-size:14px;padding:8px 0">Sem promo√ß√µes activas</div>';
  // Carregar fotos cortadas em quadrado via canvas
  av.forEach(function(p){
    if(!p.foto)return;
    var el=document.getElementById('pi_'+p.id);
    if(!el)return;
    var img=new Image();
    img.crossOrigin='anonymous';
    img.onload=function(){
      var size=Math.min(img.width,img.height);
      var sx=Math.floor((img.width-size)/2);
      var sy=Math.floor((img.height-size)/2);
      var cv=document.createElement('canvas');
      cv.width=300;cv.height=300;
      cv.getContext('2d').drawImage(img,sx,sy,size,size,0,0,300,300);
      el.src=cv.toDataURL('image/jpeg',0.8);
    };
    img.onerror=function(){el.src=p.foto;};
    img.src=p.foto;
  });
  // Folheto
  var imgs=D.folhetos.filter(function(f){return f.data&&f.data.length>10;});
  document.getElementById('fFolheto').innerHTML=imgs.length?
    '<div class="card"><div class="ct">Folheto</div><div class="fStrip">'+
    imgs.map(function(f,i){return'<div class="fTh" onclick="abrirV('+i+')"><img src="'+f.data+'" loading="lazy"></div>';}).join('')+
    '</div></div>':'';
}

function renderPerfil(){
  var c=D.eu;if(!c)return;
  var d=descEur(c.pts||0);
  document.getElementById('pInfo').innerHTML=
    '<div style="display:flex;align-items:center;gap:14px;margin-bottom:16px">'+
    '<div style="width:56px;height:56px;border-radius:50%;background:linear-gradient(135deg,var(--g),var(--gl));color:var(--n);font-size:22px;font-weight:800;display:flex;align-items:center;justify-content:center">'+c.nome.charAt(0).toUpperCase()+'</div>'+
    '<div><div style="font-size:20px;font-weight:700">'+c.nome+'</div><div style="font-size:13px;color:var(--mu)">'+(c.tel||'')+'</div><div style="font-size:14px;color:var(--g);font-weight:700">N¬∫ '+(c.num_cliente||'‚Äî')+'</div></div></div>'+
    '<div style="display:grid;grid-template-columns:1fr 1fr;gap:8px">'+
    '<div style="background:#eef2f7;border-radius:12px;padding:12px;text-align:center"><div style="font-size:20px;font-weight:800">'+(c.pts||0)+'</div><div style="font-size:10px;color:var(--mu)">PONTOS</div></div>'+
    '<div style="background:#eef2f7;border-radius:12px;padding:12px;text-align:center"><div style="font-size:20px;font-weight:800">'+(c.visitas||0)+'</div><div style="font-size:10px;color:var(--mu)">VISITAS</div></div>'+
    '<div style="background:#eef2f7;border-radius:12px;padding:12px;text-align:center"><div style="font-size:20px;font-weight:800;color:var(--gr)">'+(d>0?d.toFixed(2)+'‚Ç¨':'‚Äî')+'</div><div style="font-size:10px;color:var(--mu)">DESCONTO</div></div>'+
    '<div style="background:#eef2f7;border-radius:12px;padding:12px;text-align:center"><div style="font-size:20px;font-weight:800">'+parseFloat(c.poupado||0).toFixed(2)+'‚Ç¨</div><div style="font-size:10px;color:var(--mu)">POUPADO</div></div>'+
    '</div>';
}

// ‚îÄ‚îÄ VIEWER ‚îÄ‚îÄ
var _vIdx=0,_vImgs=[],_vTx=0;
function abrirV(i){
  _vImgs=D.folhetos.filter(function(f){return f.data&&f.data.length>10;});
  if(!_vImgs.length)return;
  _vIdx=Math.max(0,Math.min(i,_vImgs.length-1));
  var tr=document.getElementById('vTrack');
  tr.style.width=(_vImgs.length*100)+'vw';
  tr.innerHTML=_vImgs.map(function(f){return'<div class="vSlide"><img src="'+f.data+'" alt=""></div>';}).join('');
  updV();
  document.getElementById('viewer').classList.add('a');
  tr.addEventListener('touchstart',function(e){_vTx=e.touches[0].clientX;},{passive:true});
  tr.addEventListener('touchend',function(e){if(Math.abs(e.changedTouches[0].clientX-_vTx)>40)navV(e.changedTouches[0].clientX<_vTx?1:-1);});
}
function updV(){document.getElementById('vTrack').style.transform='translateX(-'+(_vIdx*100)+'vw)';document.getElementById('vCount').textContent=(_vIdx+1)+' / '+_vImgs.length;}
function navV(d){_vIdx=Math.max(0,Math.min(_vImgs.length-1,_vIdx+d));updV();}
function fecharV(){document.getElementById('viewer').classList.remove('a');}

// ‚îÄ‚îÄ REGISTO / LOGIN ‚îÄ‚îÄ
async function registar(){
  var nome=document.getElementById('rNome').value.trim();
  var tel=document.getElementById('rTel').value.trim().replace(/\s/g,'');
  if(!nome||tel.length<9){toast('‚ö†Ô∏è Preencha nome e telem√≥vel');return;}
  toast('‚è≥ A verificar...');
  // Verificar se j√° existe
  var existente=await sbGet('clientes','tel=eq.'+encodeURIComponent(tel));
  if(existente&&existente[0]){
    D.eu=existente[0];
    localStorage.setItem('M_TEL',tel);
    entrar();
    return;
  }
  // Criar novo
  var total=await sbGet('clientes');
  var num=((Array.isArray(total)?total.length:0)+1).toString().padStart(4,'0');
  var c={id:uid(),num_cliente:num,nome:nome,tel:tel,email:'',pts:0,visitas:0,carimbos:0,poupado:0,desde:hoje(),historico:[]};
  var ok=await sbUp('clientes',c);
  if(ok){
    D.eu=c;
    localStorage.setItem('M_TEL',tel);
    entrar();
    toast('‚úÖ Bem-vindo, '+nome.split(' ')[0]+'!');
  } else {
    toast('‚ö†Ô∏è Erro ao criar conta');
  }
}

async function tentarAutoLogin(){
  var tel=localStorage.getItem('M_TEL');
  if(!tel)return false;
  var r=await sbGet('clientes','tel=eq.'+encodeURIComponent(tel));
  if(r&&r[0]){D.eu=r[0];return true;}
  return false;
}

function entrar(){
  document.getElementById('eReg').style.display='none';
  document.getElementById('eApp').classList.add('v');
  document.getElementById('cabNome').textContent=D.eu.nome.split(' ')[0];
  sincronizar().then(function(){
    renderInicio();
    renderQR();
    renderFolheto();
  });
  // Auto-refresh a cada 30s
  setInterval(function(){
    sincronizar().then(function(){
      if(_tab==='Inicio')renderInicio();
      if(_tab==='Folheto')renderFolheto();
    });
  },30000);
}

function sair(){
  if(!confirm('Sair desta conta?'))return;
  localStorage.removeItem('M_TEL');
  D.eu=null;
  document.getElementById('eApp').classList.remove('v');
  document.getElementById('eReg').style.display='flex';
  document.getElementById('rNome').value='';
  document.getElementById('rTel').value='';
}

// ‚îÄ‚îÄ QR DRAW ‚îÄ‚îÄ
function qrDraw(txt,el,inv){
  if(!el)return;
  var sz=parseInt(el.getAttribute('width'))||150;
  var mat=qrMat(txt),n=mat.length,cell=sz/n;
  var bg=inv?'#0a1628':'#fff',fg=inv?'#fff':'#0a1628';
  var h='<rect width="'+sz+'" height="'+sz+'" fill="'+bg+'"/>';
  for(var r=0;r<n;r++)for(var c=0;c<n;c++)if(mat[r][c])h+='<rect x="'+(c*cell).toFixed(1)+'" y="'+(r*cell).toFixed(1)+'" width="'+(cell+.3).toFixed(1)+'" height="'+(cell+.3).toFixed(1)+'" fill="'+fg+'"/>';
  el.innerHTML=h;
}
function qrMat(t){var b=[],i,cd;for(i=0;i<t.length;i++){cd=t.charCodeAt(i);if(cd<128)b.push(cd);else if(cd<2048){b.push(0xC0|(cd>>6));b.push(0x80|(cd&63));}else{b.push(0xE0|(cd>>12));b.push(0x80|((cd>>6)&63));b.push(0x80|(cd&63));}}var v=2;if(b.length>14)v=3;if(b.length>26)v=4;if(b.length>42)v=5;if(b.length>60)v=6;if(b.length>84)v=7;if(b.length>110)v=9;return qrBld(b,v);}
function qrBld(d,v){var n=17+v*4,m=[],f=[];for(var i=0;i<n;i++){m[i]=[];f[i]=[];for(var j=0;j<n;j++){m[i][j]=false;f[i][j]=false;}}function sf(r,c,val){if(r>=0&&r<n&&c>=0&&c<n){m[r][c]=val;f[r][c]=true;}}function fp(tr,tc){for(var r=-1;r<=7;r++)for(var c=-1;c<=7;c++)sf(tr+r,tc+c,(r>=0&&r<7&&c>=0&&c<7)&&(r===0||r===6||c===0||c===6||(r>=2&&r<=4&&c>=2&&c<=4)));}fp(0,0);fp(0,n-7);fp(n-7,0);for(var i=8;i<n-8;i++){sf(6,i,i%2===0);sf(i,6,i%2===0);}sf(4*v+9,8,true);var ap={2:[6,18],3:[6,22],4:[6,26],5:[6,30],6:[6,34],7:[6,22,38],9:[6,26,46]}[v]||[];for(var ai=0;ai<ap.length;ai++)for(var aj=0;aj<ap.length;aj++){var ar=ap[ai],ac=ap[aj];if(!f[ar][ac])for(var dr=-2;dr<=2;dr++)for(var dc=-2;dc<=2;dc++)sf(ar+dr,ac+dc,dr===0&&dc===0||Math.abs(dr)===2||Math.abs(dc)===2);}var cap={2:28,3:44,4:64,5:86,6:108,7:124,9:154}[v]||44;var s=[0x04,d.length];for(var i=0;i<d.length;i++)s.push(d[i]);var pad=[0xEC,0x11];while(s.length<cap)s.push(pad[(s.length-2-d.length)%2]);var bits=[];for(var i=0;i<s.length;i++)for(var b=7;b>=0;b--)bits.push((s[i]>>b)&1);var bi=0,up=true;for(var col=n-1;col>=1;col-=2){if(col<=6)col--;for(var row=up?n-1:0;up?row>=0:row<n;row+=up?-1:1){for(var dc2=0;dc2<2;dc2++){var c2=col-dc2;if(!f[row][c2])m[row][c2]=bi<bits.length?bits[bi++]===1:false;}}up=!up;}for(var r=0;r<n;r++)for(var c=0;c<n;c++){if(!f[r][c]&&(r+c)%2===0)m[r][c]=!m[r][c];}return m;}

// ‚îÄ‚îÄ INIT ‚îÄ‚îÄ
document.addEventListener('DOMContentLoaded',function(){
  tentarAutoLogin().then(function(ok){
    if(ok)entrar();
  });
});
document.addEventListener('visibilitychange',function(){
  if(!document.hidden&&D.eu){
    sincronizar().then(function(){
      if(_tab==='Inicio')renderInicio();
      if(_tab==='Folheto')renderFolheto();
    });
  }
});
</script>
</body>
</html>
