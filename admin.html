<!DOCTYPE html>
<html lang="pt">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="theme-color" content="#0a1628">
<title>MARINHA â€“ Painel</title>
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700&family=DM+Sans:wght@400;600;700;800&display=swap" rel="stylesheet">
<style>
*{box-sizing:border-box;margin:0;padding:0;-webkit-tap-highlight-color:transparent}
:root{--n:#0a1628;--s:#1a4a8a;--g:#c9a84c;--gl:#e8c97a;--bg:#f4f1ec;--mu:#7a8a9a;--gr:#27ae60;--r:#e74c3c;--cr:#f5f0e8}
body{font-family:'DM Sans',sans-serif;background:var(--bg);color:var(--n);min-height:100vh}

/* â”€â”€ PIN â”€â”€ */
#ePin{position:fixed;inset:0;z-index:1000;background:linear-gradient(160deg,var(--n),var(--s));display:flex;flex-direction:column;align-items:center;justify-content:center;gap:20px;padding:32px}
.pT{font-family:'Playfair Display',serif;font-size:36px;color:var(--cr);letter-spacing:6px}
.pS{color:var(--g);font-size:11px;letter-spacing:3px;text-transform:uppercase}
.pDots{display:flex;gap:14px;margin:8px 0}
.pDot{width:18px;height:18px;border-radius:50%;border:2px solid rgba(255,255,255,.3);background:transparent;transition:.15s}
.pDot.on{background:var(--g);border-color:var(--g)}
.pGrid{display:grid;grid-template-columns:repeat(3,72px);gap:12px}
.pBtn{height:72px;border:none;border-radius:18px;background:rgba(255,255,255,.1);color:#fff;font-size:24px;font-weight:700;cursor:pointer;font-family:'DM Sans',sans-serif;transition:transform .1s,background .1s}
.pBtn:active{transform:scale(.92);background:rgba(255,255,255,.2)}
.pErr{color:#ff6b6b;font-size:13px;font-weight:600;min-height:20px;text-align:center}

/* â”€â”€ APP â”€â”€ */
#eApp{display:none;flex-direction:column;min-height:100vh}
#eApp.v{display:flex}
.cab{position:fixed;top:0;left:0;right:0;z-index:100;height:60px;background:linear-gradient(135deg,var(--n),var(--s));display:flex;align-items:center;gap:12px;padding:0 16px;box-shadow:0 3px 16px rgba(0,0,0,.25)}
.cabT{color:#fff;font-size:17px;font-weight:700;flex:1}
.cabS{color:rgba(255,255,255,.45);font-size:10px;letter-spacing:2px;text-transform:uppercase}
.nav{position:fixed;bottom:0;left:0;right:0;z-index:100;background:#fff;border-top:1px solid rgba(0,0,0,.07);display:flex;height:68px}
.nBtn{flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:3px;border:none;background:none;cursor:pointer;font-size:10px;font-weight:700;letter-spacing:.5px;text-transform:uppercase;color:var(--mu);font-family:'DM Sans',sans-serif}
.nBtn svg{width:22px;height:22px;stroke:currentColor;fill:none;stroke-width:1.8}
.nBtn.a{color:var(--n)}.nBtn.a svg{stroke:var(--g)}
.ecra{display:none;padding:72px 0 80px;min-height:100vh}.ecra.a{display:block}
.s{padding:0 16px}
.card{background:#fff;border-radius:16px;padding:16px;box-shadow:0 2px 12px rgba(10,22,40,.06);margin-bottom:14px}
.ct{font-size:11px;font-weight:700;color:var(--mu);letter-spacing:1.5px;text-transform:uppercase;margin-bottom:12px}
.inp{width:100%;padding:12px 14px;background:#eef2f7;border:1.5px solid rgba(26,74,138,.14);border-radius:12px;font-size:15px;color:var(--n);outline:none;margin-bottom:10px;font-family:'DM Sans',sans-serif;-webkit-appearance:none;-webkit-tap-highlight-color:transparent}
.inp:focus{border-color:var(--s)}
.lbl{font-size:11px;font-weight:700;color:var(--mu);letter-spacing:1px;text-transform:uppercase;margin-bottom:5px;display:block}
.bP{width:100%;padding:15px;background:linear-gradient(135deg,var(--g),var(--gl));color:var(--n);border:none;border-radius:14px;font-weight:800;font-size:15px;cursor:pointer;font-family:'DM Sans',sans-serif}
.bS{width:100%;padding:13px;background:#eef2f7;color:var(--s);border:1.5px solid rgba(26,74,138,.18);border-radius:14px;font-weight:700;font-size:14px;cursor:pointer;font-family:'DM Sans',sans-serif;margin-bottom:8px}
.bD{width:100%;padding:13px;background:rgba(231,76,60,.07);color:var(--r);border:1.5px solid rgba(231,76,60,.2);border-radius:14px;font-weight:700;font-size:14px;cursor:pointer;font-family:'DM Sans',sans-serif}
.row{display:flex;gap:10px}
.row>.bS,.row>.bP{flex:1}
.stat{display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px;margin-bottom:16px}
.sItem{background:#fff;border-radius:14px;padding:14px 8px;text-align:center;box-shadow:0 2px 8px rgba(10,22,40,.06)}
.sVal{font-size:24px;font-weight:800;color:var(--n)}
.sLbl{font-size:10px;color:var(--mu);margin-top:2px}
.avatar{width:42px;height:42px;border-radius:50%;background:linear-gradient(135deg,var(--g),var(--gl));color:var(--n);font-size:18px;font-weight:800;display:flex;align-items:center;justify-content:center;flex-shrink:0}
.cRow{display:flex;align-items:center;gap:12px;padding:12px 0;border-bottom:1px solid rgba(0,0,0,.06);cursor:pointer}
.cPts{font-size:18px;font-weight:800;color:var(--n)}.cPtsL{font-size:10px;color:var(--mu);text-align:center}
.fThumb{flex-shrink:0;width:80px;height:110px;border-radius:10px;overflow:hidden;cursor:pointer;background:#eef2f7;display:flex;align-items:center;justify-content:center;font-size:24px}
.fThumb img{width:100%;height:100%;object-fit:cover}
.strip{display:flex;gap:10px;overflow-x:auto;padding:4px 0 8px;scrollbar-width:none}.strip::-webkit-scrollbar{display:none}
.pGrid2{display:grid;grid-template-columns:1fr 1fr;gap:10px}
.pCard{background:#fff;border-radius:14px;overflow:hidden;box-shadow:0 2px 10px rgba(10,22,40,.07);cursor:pointer}
.pImg{width:100%;height:0;padding-bottom:100%;background:#eef2f7;position:relative;overflow:hidden}
.pImg img{position:absolute;top:0;left:0;width:100%;height:100%;object-fit:cover}
.pBdg{position:absolute;top:6px;left:6px;background:var(--r);color:#fff;font-size:10px;font-weight:700;padding:2px 6px;border-radius:6px}
.pBody{padding:10px}.pNome{font-size:13px;font-weight:700;margin-bottom:3px}
.precos{display:flex;align-items:center;gap:6px}
.pOrig{font-size:11px;color:var(--mu);text-decoration:line-through}
.pNovo{font-size:15px;font-weight:800;color:var(--r)}
.modal{display:none;position:fixed;inset:0;z-index:500;align-items:flex-end;background:rgba(0,0,0,.45);touch-action:auto}
.modal.a{display:flex}
.mBox{background:#fff;border-radius:20px 20px 0 0;width:100%;padding:20px;max-height:85vh;overflow-y:auto;-webkit-overflow-scrolling:touch;position:relative}
.mTit{font-size:18px;font-weight:800;margin-bottom:16px}
.viewer{display:none;position:fixed;inset:0;z-index:800;background:#000;flex-direction:column}
.viewer.a{display:flex}
.vTrack{display:flex;transition:transform .3s;height:100%}
.vSlide{flex-shrink:0;width:100vw;display:flex;align-items:center;justify-content:center}
.vSlide img{width:100%;height:100%;object-fit:contain;touch-action:pan-y pinch-zoom}
.vTop{position:absolute;top:0;left:0;right:0;padding:14px;background:linear-gradient(rgba(0,0,0,.6),transparent);display:flex;align-items:center;gap:10px;z-index:10}
.vBtn{padding:8px 14px;background:rgba(255,255,255,.15);border:none;color:#fff;border-radius:8px;cursor:pointer;font-family:'DM Sans',sans-serif;font-size:14px}
.scan-box{background:linear-gradient(160deg,var(--n),var(--s));border-radius:18px;padding:20px;margin-bottom:14px}
.cWrap{display:none;border-radius:16px;overflow:hidden;margin-bottom:12px}.cWrap.a{display:block}
#qrVid{width:100%;display:block;max-height:260px;object-fit:cover}
.qrRes{background:rgba(255,255,255,.1);border-radius:14px;padding:14px;margin-top:10px;display:none}.qrRes.a{display:block}
.scan-inp{width:100%;padding:12px;background:rgba(255,255,255,.1);border:1.5px solid rgba(255,255,255,.2);border-radius:12px;color:#fff;font-size:15px;font-family:'DM Sans',sans-serif;outline:none;margin-bottom:8px}
.scan-inp::placeholder{color:rgba(255,255,255,.4)}
.sResItem{display:flex;align-items:center;gap:10px;padding:10px;border-radius:10px;cursor:pointer;background:rgba(255,255,255,.08);margin-bottom:6px}
.sAvatar{width:36px;height:36px;border-radius:50%;background:rgba(201,168,76,.3);color:var(--g);font-size:16px;font-weight:700;display:flex;align-items:center;justify-content:center;flex-shrink:0}
#toast{position:fixed;bottom:80px;left:50%;transform:translateX(-50%) translateY(8px);background:var(--n);color:#fff;padding:10px 20px;border-radius:24px;font-size:14px;font-weight:600;z-index:9999;opacity:0;transition:.2s;pointer-events:none;white-space:nowrap}
#toast.v{opacity:1;transform:translateX(-50%) translateY(0)}
</style>
</head>
<body>

<!-- PIN -->
<div id="ePin">
  <div class="pT">MARINHA</div>
  <div class="pS">Painel da Loja</div>
  <div class="pDots">
    <div class="pDot" id="d0"></div>
    <div class="pDot" id="d1"></div>
    <div class="pDot" id="d2"></div>
    <div class="pDot" id="d3"></div>
  </div>
  <div class="pErr" id="pErr"></div>
  <div class="pGrid">
    <button class="pBtn" onclick="pd('1')">1</button>
    <button class="pBtn" onclick="pd('2')">2</button>
    <button class="pBtn" onclick="pd('3')">3</button>
    <button class="pBtn" onclick="pd('4')">4</button>
    <button class="pBtn" onclick="pd('5')">5</button>
    <button class="pBtn" onclick="pd('6')">6</button>
    <button class="pBtn" onclick="pd('7')">7</button>
    <button class="pBtn" onclick="pd('8')">8</button>
    <button class="pBtn" onclick="pd('9')">9</button>
    <button class="pBtn" style="opacity:.3" onclick="pd('')"></button>
    <button class="pBtn" onclick="pd('0')">0</button>
    <button class="pBtn" onclick="pa()">âŒ«</button>
  </div>
</div>

<!-- APP -->
<div id="eApp">
  <div class="cab">
    <div>
      <div class="cabT" id="cabNome">MARINHA</div>
      <div class="cabS">Painel da Loja</div>
    </div>
  </div>

  <!-- DASHBOARD -->
  <div class="ecra a" id="ecraDash">
    <div class="s">
      <div style="height:10px"></div>
      <div class="stat">
        <div class="sItem"><div class="sVal" id="sDia">0</div><div class="sLbl">Hoje</div></div>
        <div class="sItem"><div class="sVal" id="sCli">0</div><div class="sLbl">Clientes</div></div>
        <div class="sItem"><div class="sVal" id="sPro">0</div><div class="sLbl">PromoÃ§Ãµes</div></div>
      </div>
      <div class="card">
        <div class="ct">Clientes recentes</div>
        <div id="dRecentes"></div>
      </div>
    </div>
  </div>

  <!-- CLIENTES -->
  <div class="ecra" id="ecraClientes">
    <div class="s">
      <div style="height:10px"></div>
      <input class="inp" type="search" placeholder="ğŸ” Pesquisar..." oninput="filtrarCli(this.value)" id="iPesq">
      <div style="font-size:12px;color:var(--mu);margin-bottom:10px" id="cCont">0 clientes</div>
      <button class="bP" style="margin-bottom:14px" onclick="abrirNovoCli()">+ Novo Cliente</button>
      <div id="listaCli"></div>
    </div>
  </div>

  <!-- FOLHETO/PROMOS -->
  <div class="ecra" id="ecraFolheto">
    <div class="s">
      <div style="height:10px"></div>
      <div class="card">
        <div class="ct">PromoÃ§Ãµes</div>
        <button class="bP" style="margin-bottom:12px" onclick="abrirNovaPromo()">+ Nova PromoÃ§Ã£o</button>
        <div id="listaPromos"></div>
      </div>
      <div class="card">
        <div class="ct">Folheto (pÃ¡ginas)</div>
        <label class="bS" style="text-align:center;cursor:pointer;display:block">
          ğŸ“ Adicionar imagens
          <input type="file" accept="image/*" multiple onchange="addFolheto(event)" style="display:none">
        </label>
        <div class="strip" id="stripFol" style="margin-top:10px"></div>
      </div>
    </div>
  </div>

  <!-- SCANNER -->
  <div class="ecra" id="ecraScan">
    <div class="s">
      <div style="height:10px"></div>
      <div class="scan-box">
        <div style="color:rgba(255,255,255,.5);font-size:11px;letter-spacing:2px;text-transform:uppercase;margin-bottom:10px">Scanner QR</div>
        <div class="cWrap" id="cWrap">
          <video id="qrVid" autoplay muted playsinline></video>
          <div style="color:rgba(255,255,255,.6);font-size:12px;text-align:center;padding:6px" id="sCamStatus"></div>
        </div>
        <div id="sPrincipal">
          <button class="bP" style="margin-bottom:8px" onclick="iniciarCam()">ğŸ“· Abrir cÃ¢mara</button>
          <label class="bS" style="text-align:center;cursor:pointer;display:block">
            ğŸ–¼ï¸ Ler QR de foto
            <input type="file" accept="image/*" onchange="lerQRFoto(this)" style="display:none">
          </label>
        </div>
        <input class="scan-inp" type="text" placeholder="ğŸ” Ou pesquisar cliente..." oninput="pesqScan(this.value)" id="iScan">
        <div id="resScan"></div>
        <div class="qrRes" id="qrRes">
          <div style="color:#fff;font-size:16px;font-weight:700" id="qrResTit"></div>
          <div style="color:rgba(255,255,255,.7);font-size:14px;margin:4px 0" id="qrResNome"></div>
          <div style="color:var(--g);font-size:13px;margin-bottom:12px" id="qrResSub"></div>
          <div class="row">
            <button class="bP" id="qrBtnCompra">ğŸ’³ Registar compra</button>
            <button class="bS" onclick="fecharQR()">Fechar</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- CONFIG -->
  <div class="ecra" id="ecraConfig">
    <div class="s">
      <div style="height:10px"></div>
      <div class="card">
        <div class="ct">ConfiguraÃ§Ã£o</div>
        <label class="lbl">Nome da loja</label>
        <input class="inp" id="cfgNome" type="text" placeholder="Nome da loja">
        <label class="lbl">Pontos por â‚¬ gasto</label>
        <input class="inp" id="cfgPtsEuro" type="number" value="10">
        <label class="lbl">Pontos para 1â‚¬ desconto</label>
        <input class="inp" id="cfgPtsDesc" type="number" value="100">
        <button class="bP" onclick="guardarCfg()">âœ… Guardar</button>
      </div>
      <div class="card">
        <div class="ct">Link App Cliente</div>
        <div style="font-size:12px;word-break:break-all;color:var(--s);margin-bottom:10px" id="cfgLink"></div>
        <div class="row">
          <button class="bS" onclick="copiarLink()">ğŸ“‹ Copiar link</button>
          <button class="bS" onclick="imprimirQR()">ğŸ–¨ï¸ Imprimir QR</button>
        </div>
        <div style="margin-top:12px;text-align:center">
          <svg id="qrCfg" width="150" height="150" viewBox="0 0 150 150"></svg>
        </div>
      </div>
      <div class="card">
        <div class="ct">Dados</div>
        <button class="bS" onclick="exportar()">ğŸ“¤ Exportar backup</button>
      </div>
    </div>
  </div>

  <nav class="nav">
    <button class="nBtn a" id="nDash" onclick="irTab('Dash')">
      <svg viewBox="0 0 24 24"><path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>Inicio
    </button>
    <button class="nBtn" id="nClientes" onclick="irTab('Clientes')">
      <svg viewBox="0 0 24 24"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87M16 3.13a4 4 0 0 1 0 7.75"/></svg>Clientes
    </button>
    <button class="nBtn" id="nFolheto" onclick="irTab('Folheto')">
      <svg viewBox="0 0 24 24"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/></svg>Promos
    </button>
    <button class="nBtn" id="nScan" onclick="irTab('Scan')">
      <svg viewBox="0 0 24 24"><rect x="3" y="3" width="5" height="5"/><rect x="16" y="3" width="5" height="5"/><rect x="3" y="16" width="5" height="5"/><path d="M21 16h-3a2 2 0 0 0-2 2v3M21 21v.01M12 7v3a2 2 0 0 1-2 2H7"/></svg>Scanner
    </button>
    <button class="nBtn" id="nConfig" onclick="irTab('Config')">
      <svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1-2.83 2.83l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-4 0v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83-2.83l.06-.06A1.65 1.65 0 0 0 4.68 15a1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1 0-4h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 2.83-2.83l.06.06A1.65 1.65 0 0 0 9 4.68a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 4 0v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 2.83l-.06.06A1.65 1.65 0 0 0 19.4 9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 0 4h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg>Config
    </button>
  </nav>
</div>

<!-- MODAL CLIENTE -->
<div class="modal" id="mCli">
  <div class="mBox">
    <div class="mTit" id="mCliTit">Novo Cliente</div>
    <input type="hidden" id="mCliId">
    <label class="lbl">Nome *</label>
    <input class="inp" id="mCliNome" type="text" placeholder="Nome completo">
    <label class="lbl">TelemÃ³vel *</label>
    <input class="inp" id="mCliTel" type="tel" placeholder="912 345 678">
    <label class="lbl">Email</label>
    <input class="inp" id="mCliEmail" type="email" placeholder="email@exemplo.com">
    <button class="bP" style="margin-bottom:8px" onclick="guardarCli()">âœ… Guardar</button>
    <button class="bS" onclick="fecharModal('mCli')">Cancelar</button>
    <div id="wApagarCli" style="display:none;margin-top:8px">
      <button class="bD" onclick="apagarCli()">ğŸ—‘ï¸ Apagar cliente</button>
    </div>
  </div>
</div>

<!-- MODAL DETALHE CLIENTE -->
<div class="modal" id="mDet">
  <div class="mBox">
    <div id="mDetCont"></div>
    <button class="bS" style="margin-top:8px" onclick="fecharModal('mDet')">Fechar</button>
  </div>
</div>

<!-- MODAL PROMOÃ‡ÃƒO -->
<div class="modal" id="mPromo">
  <div class="mBox">
    <div class="mTit" id="mPromoTit">Nova PromoÃ§Ã£o</div>
    <input type="hidden" id="mPromoId">
    <label class="lbl">Nome *</label>
    <input class="inp" id="mPromoNome" type="text" placeholder="Ex: Cigala fresca">
    <label class="lbl">Emoji (opcional)</label>
    <input class="inp" id="mPromoEmoji" type="text" placeholder="ğŸ¦">
    <label class="lbl">Foto (opcional)</label>
    <div id="mPromoFotoPrev" style="width:80px;height:80px;border-radius:12px;background:#eef2f7;display:flex;align-items:center;justify-content:center;font-size:32px;margin-bottom:8px;overflow:hidden;position:relative;flex-shrink:0">
      <span id="mPromoFotoEmoji">ğŸ›’</span>
      <img id="mPromoFotoImg" style="display:none;position:absolute;inset:0;width:100%;height:100%;object-fit:cover;border-radius:12px">
    </div>
    <label class="bS" style="text-align:center;cursor:pointer;display:block;margin-bottom:10px">
      ğŸ“· Escolher foto
      <input type="file" accept="image/*" onchange="prevFoto(event)" style="display:none">
    </label>
    <div class="row">
      <div style="flex:1">
        <label class="lbl">PreÃ§o original (â‚¬)</label>
        <input class="inp" id="mPromoOrig" type="number" step="0.01" placeholder="0.00">
      </div>
      <div style="flex:1">
        <label class="lbl">PreÃ§o novo (â‚¬)</label>
        <input class="inp" id="mPromoNovo" type="number" step="0.01" placeholder="0.00">
      </div>
    </div>
    <div class="row">
      <div style="flex:1">
        <label class="lbl">Data inÃ­cio</label>
        <input class="inp" id="mPromoIni" type="date">
      </div>
      <div style="flex:1">
        <label class="lbl">Data fim</label>
        <input class="inp" id="mPromoFim" type="date">
      </div>
    </div>
    <button class="bP" style="margin-bottom:8px" onclick="guardarPromo()">âœ… Guardar</button>
    <button class="bS" onclick="fecharModal('mPromo')">Cancelar</button>
    <div id="wApagarPromo" style="display:none;margin-top:8px">
      <button class="bD" onclick="apagarPromo()">ğŸ—‘ï¸ Apagar promoÃ§Ã£o</button>
    </div>
  </div>
</div>

<!-- MODAL COMPRA -->
<div class="modal" id="mCompra">
  <div class="mBox">
    <div class="mTit">Registar Compra</div>
    <label class="lbl">Cliente</label>
    <select class="inp" id="mCompraCli" onchange="updCompra()">
      <option value="">Selecionar...</option>
    </select>
    <div id="mCompraDesc" style="margin-bottom:10px"></div>
    <label class="lbl">Valor da compra (â‚¬)</label>
    <input class="inp" id="mCompraVal" type="number" step="0.01" placeholder="0.00" oninput="calcCompra()">
    <div id="mCompraPrev" style="display:none;background:#eef2f7;border-radius:10px;padding:10px;margin-bottom:10px;font-size:14px;color:var(--s);font-weight:700"></div>
    <button class="bP" style="margin-bottom:8px" onclick="confirmarCompra()">âœ… Confirmar compra</button>
    <button class="bS" onclick="fecharModal('mCompra')">Cancelar</button>
  </div>
</div>

<!-- MODAL RECIBO -->
<div class="modal" id="mRecibo">
  <div class="mBox" style="text-align:center">
    <div style="font-size:40px;margin-bottom:8px">âœ…</div>
    <div style="font-size:20px;font-weight:800;margin-bottom:4px" id="rNome"></div>
    <div style="font-size:14px;color:var(--gr);font-weight:700;margin-bottom:2px" id="rPts"></div>
    <div style="font-size:13px;color:var(--mu);margin-bottom:4px" id="rTotal"></div>
    <div style="font-size:13px;color:var(--gr);margin-bottom:16px" id="rDesc"></div>
    <div style="background:var(--n);border-radius:14px;padding:14px;display:inline-block;margin-bottom:14px">
      <svg id="rQR" width="150" height="150" viewBox="0 0 150 150"></svg>
    </div>
    <button class="bP" onclick="fecharModal('mRecibo')">Fechar</button>
  </div>
</div>

<!-- VIEWER FOLHETO -->
<div class="viewer" id="viewer">
  <div class="vTop">
    <button class="vBtn" onclick="fecharViewer()">â† Fechar</button>
    <span style="color:rgba(255,255,255,.6);font-size:13px" id="vCount"></span>
    <div style="flex:1"></div>
    <button class="vBtn" onclick="navV(-1)">â€¹</button>
    <button class="vBtn" onclick="navV(1)">â€º</button>
  </div>
  <div class="vTrack" id="vTrack"></div>
</div>

<div id="toast"></div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  SUPABASE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
var SB='https://opzmuzogxfzeqwjxmfvc.supabase.co';
var SK='sb_publishable_e_Bd_rx2rfzBeIrbyGxCwA_SfXklv4s';
function hd(){return{'apikey':SK,'Authorization':'Bearer '+SK,'Content-Type':'application/json'};}
async function sbGet(t,q){
  try{var r=await fetch(SB+'/rest/v1/'+t+'?select=*'+(q?'&'+q:''),{headers:hd()});return r.ok?r.json():[];}
  catch(e){return[];}
}
async function sbUp(t,d){
  try{
    var body=JSON.stringify(Array.isArray(d)?d:[d]);
    console.log('sbUp',t,'tamanho:',Math.round(body.length/1024)+'KB');
    var r=await fetch(SB+'/rest/v1/'+t,{
      method:'POST',
      headers:Object.assign({},hd(),{'Prefer':'resolution=merge-duplicates'}),
      body:body
    });
    if(!r.ok){
      var txt=await r.text();
      console.error('sbUp ERRO',t,r.status,txt);
      toast('âš ï¸ Supabase rejeitou ('+r.status+'): '+txt.slice(0,100),5000);
    } else {
      console.log('sbUp OK',t);
    }
    return r.ok;
  }catch(e){
    console.error('sbUp exc',e);
    toast('âš ï¸ Sem ligaÃ§Ã£o',3000);
    return false;
  }
}

// Upload de imagem para Supabase Storage
async function sbImgUp(bucket, path, base64){
  if(!base64||!base64.startsWith('data:')) return '';
  try{
    var parts=base64.split(',');
    var mime=parts[0].match(/:(.*?);/)[1];
    var bin=atob(parts[1]);
    var arr=new Uint8Array(bin.length);
    for(var i=0;i<bin.length;i++) arr[i]=bin.charCodeAt(i);
    var blob=new Blob([arr],{type:mime});
    var url=SB+'/storage/v1/object/'+bucket+'/'+path;
    var r=await fetch(url,{
      method:'POST',
      headers:{'apikey':SK,'Authorization':'Bearer '+SK,'Content-Type':mime,'x-upsert':'true'},
      body:blob
    });
    if(!r.ok){
      var txt=await r.text();
      console.error('sbImgUp erro',r.status,txt);
      return '';
    }
    return SB+'/storage/v1/object/public/'+bucket+'/'+path;
  }catch(e){
    console.error('sbImgUp exc',e);
    return '';
  }
}
async function sbDel(t,id){
  try{var r=await fetch(SB+'/rest/v1/'+t+'?id=eq.'+id,{method:'DELETE',headers:hd()});return r.ok;}
  catch(e){return false;}
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  DADOS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
var DB={clientes:[],promos:[],folhetos:[],cfg:{nomeLoja:'',ptsEuro:10,ptsDesc:100}};
var _fotoPromo = ''; // foto actual no modal promo

// IDB imagens
var _idb=null;
function idb(){return new Promise(function(res,rej){if(_idb)return res(_idb);var r=indexedDB.open('MARINHA',1);r.onupgradeneeded=function(e){e.target.result.createObjectStore('imgs');};r.onsuccess=function(e){_idb=e.target.result;res(_idb);};r.onerror=rej;});}
function idbSet(k,v){return idb().then(function(db){return new Promise(function(res,rej){var tx=db.transaction('imgs','readwrite');tx.objectStore('imgs').put(v,k);tx.oncomplete=res;tx.onerror=rej;});});}
function idbGet(k){return idb().then(function(db){return new Promise(function(res,rej){var tx=db.transaction('imgs','readonly');var r=tx.objectStore('imgs').get(k);r.onsuccess=function(){res(r.result);};r.onerror=rej;});});}

async function sincronizar(){
  var r=await Promise.all([sbGet('clientes'),sbGet('promos'),sbGet('folhetos'),sbGet('config','id=eq.1')]);
  if(Array.isArray(r[0]))DB.clientes=r[0];
  if(Array.isArray(r[1]))DB.promos=r[1];
  if(Array.isArray(r[2])){
    DB.folhetos=r[2];
    // Se nÃ£o tem URL do Storage, tentar IDB local como cache
    DB.folhetos.forEach(function(f,i){
      if(!f.data || f.data===''){ 
        idbGet('F_'+f.id).then(function(d){
          if(d)DB.folhetos[i].data=d;
          renderFolheto();
        }).catch(function(){});
      }
    });
  }
  if(r[3]&&r[3][0]){var c=r[3][0];DB.cfg.nomeLoja=c.nome_loja||'';DB.cfg.ptsEuro=c.pts_euro||10;DB.cfg.ptsDesc=c.pts_desc||100;}
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  UTILS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function uid(){return Date.now().toString(36)+Math.random().toString(36).slice(2,5);}
function hoje(){return new Date().toISOString().slice(0,10);}
function fd(d){return d?new Date(d).toLocaleDateString('pt-PT',{day:'2-digit',month:'short'}):'â€”';}
function nivel(p){return p>=2000?'ğŸ’ Diamante':p>=1000?'ğŸ¥‡ Ouro':p>=500?'ğŸ¥ˆ Prata':'ğŸ¥‰ Bronze';}
function descEur(p){return Math.floor((p||0)/(DB.cfg.ptsDesc||100));}
function toast(m,ms){var t=document.getElementById('toast');t.textContent=m;t.classList.add('v');clearTimeout(t._t);t._t=setTimeout(function(){t.classList.remove('v');},ms||2500);}
function fecharModal(id){document.getElementById(id).classList.remove('a');}
function promosAtivas(){var h=hoje();return DB.promos.filter(function(p){return(!p.data_ini||p.data_ini<=h)&&(!p.data_fim||p.data_fim>=h);});}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  PIN
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
var _pin='', _pinOk=localStorage.getItem('MPIN')||'1234';
function pd(d){
  if(!d)return;
  if(_pin.length>=4)return;
  _pin+=d;
  for(var i=0;i<4;i++)document.getElementById('d'+i).classList.toggle('on',i<_pin.length);
  if(_pin.length===4){
    setTimeout(function(){
      if(_pin===_pinOk){
        document.getElementById('ePin').style.display='none';
        document.getElementById('eApp').classList.add('v');
        irTab('Dash');
        sincronizar().then(function(){renderDash();});
      } else {
        document.getElementById('pErr').textContent='PIN incorrecto';
        _pin='';
        for(var i=0;i<4;i++)document.getElementById('d'+i).classList.remove('on');
        setTimeout(function(){document.getElementById('pErr').textContent='';},1500);
      }
    },200);
  }
}
function pa(){
  if(!_pin.length)return;
  _pin=_pin.slice(0,-1);
  for(var i=0;i<4;i++)document.getElementById('d'+i).classList.toggle('on',i<_pin.length);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  NAV
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
var _tab='Dash';
function irTab(tab){
  pararCam();
  _tab=tab;
  document.querySelectorAll('.ecra').forEach(function(e){e.classList.remove('a');});
  document.querySelectorAll('.nBtn').forEach(function(e){e.classList.remove('a');});
  document.getElementById('ecra'+tab).classList.add('a');
  document.getElementById('n'+tab).classList.add('a');
  if(tab==='Dash')renderDash();
  if(tab==='Clientes')renderCli('');
  if(tab==='Folheto'){renderPromos();renderFolheto();}
  if(tab==='Config')renderCfg();
  window.scrollTo(0,0);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  DASHBOARD
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderDash(){
  document.getElementById('cabNome').textContent=DB.cfg.nomeLoja||'MARINHA';
  var h=hoje();
  var hj=DB.clientes.filter(function(c){return(c.historico||[]).some(function(x){return(x.data||'').slice(0,10)===h;});});
  document.getElementById('sDia').textContent=hj.length;
  document.getElementById('sCli').textContent=DB.clientes.length;
  document.getElementById('sPro').textContent=promosAtivas().length;
  var rec=DB.clientes.slice().sort(function(a,b){
    var da=(a.historico&&a.historico[0])?a.historico[0].data:'';
    var db=(b.historico&&b.historico[0])?b.historico[0].data:'';
    return db.localeCompare(da);
  }).slice(0,6);
  document.getElementById('dRecentes').innerHTML=rec.length?rec.map(function(c){
    return '<div class="cRow" onclick="verCli(\''+c.id+'\')">'+
      '<div class="avatar">'+c.nome.charAt(0).toUpperCase()+'</div>'+
      '<div style="flex:1"><div style="font-weight:700">'+c.nome+'</div>'+
      '<div style="font-size:12px;color:var(--mu)">NÂº '+(c.num_cliente||'â€”')+' Â· '+(c.pts||0)+' pts</div></div>'+
      '<div style="font-size:13px;color:var(--g);font-weight:700">'+nivel(c.pts||0).split(' ')[1]+'</div></div>';
  }).join(''):'<div style="color:var(--mu);font-size:14px;padding:8px 0">Sem clientes ainda</div>';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  CLIENTES
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderCli(f){
  f=(f||'').toLowerCase();
  var l=DB.clientes.filter(function(c){return!f||c.nome.toLowerCase().includes(f)||(c.tel||'').includes(f)||(c.num_cliente||'').includes(f);});
  document.getElementById('cCont').textContent=l.length+' cliente'+(l.length!==1?'s':'');
  document.getElementById('listaCli').innerHTML=l.map(function(c){
    return '<div class="cRow" onclick="verCli(\''+c.id+'\')">'+
      '<div class="avatar">'+c.nome.charAt(0).toUpperCase()+'</div>'+
      '<div style="flex:1"><div style="font-weight:700;font-size:15px">'+c.nome+'</div>'+
      '<div style="font-size:12px;color:var(--mu)">'+(c.tel||'')+' Â· <span style="color:var(--g);font-family:monospace">NÂº '+(c.num_cliente||'â€”')+'</span></div>'+
      '<div style="font-size:11px;color:var(--mu)">'+nivel(c.pts||0)+'</div></div>'+
      '<div><div class="cPts">'+(c.pts||0)+'</div><div class="cPtsL">pts</div></div></div>';
  }).join('');
}
function filtrarCli(v){renderCli(v);}

function verCli(id){
  var c=DB.clientes.find(function(x){return x.id===id;});if(!c)return;
  var d=descEur(c.pts||0);
  document.getElementById('mDetCont').innerHTML=
    '<div style="display:flex;align-items:center;gap:14px;margin-bottom:16px">'+
    '<div class="avatar" style="width:56px;height:56px;font-size:22px">'+c.nome.charAt(0).toUpperCase()+'</div>'+
    '<div><div style="font-size:20px;font-weight:700">'+c.nome+'</div>'+
    '<div style="font-size:13px;color:var(--mu)">'+(c.tel||'')+'</div>'+
    '<div style="font-size:14px;color:var(--g);font-weight:700">NÂº '+(c.num_cliente||'â€”')+'</div></div></div>'+
    '<div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px;margin-bottom:14px">'+
    '<div style="background:#eef2f7;border-radius:12px;padding:12px;text-align:center"><div style="font-size:20px;font-weight:800">'+(c.pts||0)+'</div><div style="font-size:10px;color:var(--mu)">PONTOS</div></div>'+
    '<div style="background:#eef2f7;border-radius:12px;padding:12px;text-align:center"><div style="font-size:20px;font-weight:800">'+(c.visitas||0)+'</div><div style="font-size:10px;color:var(--mu)">VISITAS</div></div>'+
    '<div style="background:#eef2f7;border-radius:12px;padding:12px;text-align:center"><div style="font-size:20px;font-weight:800;color:var(--gr)">'+(d>0?d.toFixed(2)+'â‚¬':'â€”')+'</div><div style="font-size:10px;color:var(--mu)">DESCONTO</div></div></div>'+
    '<div class="row" style="margin-bottom:8px">'+
    '<button class="bP" onclick="fecharModal(\'mDet\');abrirCompra(\''+c.id+'\')">ğŸ’³ Compra</button>'+
    '<button class="bS" onclick="fecharModal(\'mDet\');editarCli(\''+c.id+'\')">âœï¸ Editar</button></div>'+
    '<div style="font-size:11px;font-weight:700;color:var(--mu);letter-spacing:1px;text-transform:uppercase;margin-bottom:8px">HistÃ³rico</div>'+
    ((c.historico||[]).slice(0,6).map(function(h){
      return '<div style="display:flex;align-items:center;gap:10px;padding:8px 0;border-bottom:1px solid rgba(0,0,0,.05)">'+
        '<span style="font-size:16px">'+(h.desconto>0?'ğŸ’°':'â­')+'</span>'+
        '<div style="flex:1"><div style="font-size:13px;font-weight:600">'+h.desc+'</div>'+
        '<div style="font-size:11px;color:var(--mu)">'+fd(h.data)+'</div></div>'+
        '<div style="font-size:13px;font-weight:700;color:var(--gr)">+'+h.pts+' pts</div></div>';
    }).join('')||'<div style="color:var(--mu);font-size:13px">Sem histÃ³rico</div>');
  document.getElementById('mDet').classList.add('a');
}

function abrirNovoCli(){
  document.getElementById('mCliId').value='';
  document.getElementById('mCliTit').textContent='Novo Cliente';
  document.getElementById('mCliNome').value='';
  document.getElementById('mCliTel').value='';
  document.getElementById('mCliEmail').value='';
  document.getElementById('wApagarCli').style.display='none';
  document.getElementById('mCli').classList.add('a');
}
function editarCli(id){
  var c=DB.clientes.find(function(x){return x.id===id;});if(!c)return;
  document.getElementById('mCliId').value=c.id;
  document.getElementById('mCliTit').textContent='Editar Cliente';
  document.getElementById('mCliNome').value=c.nome||'';
  document.getElementById('mCliTel').value=c.tel||'';
  document.getElementById('mCliEmail').value=c.email||'';
  document.getElementById('wApagarCli').style.display='block';
  document.getElementById('mCli').classList.add('a');
}
async function guardarCli(){
  var id=document.getElementById('mCliId').value;
  var nome=document.getElementById('mCliNome').value.trim();
  var tel=document.getElementById('mCliTel').value.trim();
  if(!nome||!tel){toast('âš ï¸ Nome e telemÃ³vel obrigatÃ³rios');return;}
  toast('â³ A guardar...');
  var c;
  if(id){
    c=DB.clientes.find(function(x){return x.id===id;});
    if(c){c.nome=nome;c.tel=tel;c.email=document.getElementById('mCliEmail').value;}
  } else {
    var n=(DB.clientes.length+1).toString().padStart(4,'0');
    c={id:uid(),num_cliente:n,nome:nome,tel:tel,email:document.getElementById('mCliEmail').value,pts:0,visitas:0,carimbos:0,poupado:0,desde:hoje(),historico:[]};
    DB.clientes.push(c);
  }
  var ok=await sbUp('clientes',c);
  fecharModal('mCli');
  renderCli(document.getElementById('iPesq').value);
  toast(ok?(id?'âœ… Actualizado':'âœ… Cliente criado'):'âš ï¸ Erro');
}
async function apagarCli(){
  var id=document.getElementById('mCliId').value;
  if(!confirm('Apagar cliente?'))return;
  await sbDel('clientes',id);
  DB.clientes=DB.clientes.filter(function(x){return x.id!==id;});
  fecharModal('mCli');renderCli('');toast('ğŸ—‘ï¸ Removido');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  PROMOÃ‡Ã•ES
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderPromos(){
  var el=document.getElementById('listaPromos');
  if(!DB.promos.length){el.innerHTML='<div style="color:var(--mu);font-size:14px;padding:8px 0">Sem promoÃ§Ãµes</div>';return;}
  var h=hoje();
  el.innerHTML='<div class="pGrid2">'+DB.promos.map(function(p){
    var po=parseFloat(p.preco_orig)||0,pn=parseFloat(p.preco_novo)||0;
    var pct=(po>0&&pn>0)?Math.round((1-pn/po)*100):0;
    return '<div class="pCard" onclick="editarPromo(\''+p.id+'\')">'+
      '<div class="pImg">'+(p.foto?'<img src="'+p.foto+'?cb='+Date.now()+'" style="position:absolute;top:0;left:0;width:100%;height:100%;object-fit:cover" onerror="this.style.display=\'none\'">':(p.emoji||'ğŸ›’'))+(pct>0?'<div class="pBdg">-'+pct+'%</div>':'')+'</div>'+
      '<div class="pBody"><div class="pNome">'+p.nome+'</div>'+
      '<div class="precos">'+(po>0?'<span class="pOrig">'+po.toFixed(2)+'â‚¬</span>':'')+(pn>0?'<span class="pNovo">'+pn.toFixed(2)+'â‚¬</span>':'')+'</div>'+
      '</div></div>';
  }).join('')+'</div>';
}
function abrirNovaPromo(){
  _fotoPromo='';
  document.getElementById('mPromoId').value='';
  document.getElementById('mPromoTit').textContent='Nova PromoÃ§Ã£o';
  ['mPromoNome','mPromoEmoji','mPromoOrig','mPromoNovo','mPromoIni','mPromoFim'].forEach(function(i){document.getElementById(i).value='';});
  var img=document.getElementById('mPromoFotoImg'); if(img){img.src='';img.style.display='none';}
  var em=document.getElementById('mPromoFotoEmoji'); if(em)em.style.display='';
  document.getElementById('wApagarPromo').style.display='none';
  document.getElementById('mPromo').classList.add('a');
}
function editarPromo(id){
  var p=DB.promos.find(function(x){return x.id===id;});if(!p)return;
  document.getElementById('mPromoId').value=p.id;
  document.getElementById('mPromoTit').textContent='Editar PromoÃ§Ã£o';
  document.getElementById('mPromoNome').value=p.nome||'';
  document.getElementById('mPromoEmoji').value=p.emoji||'';
  document.getElementById('mPromoOrig').value=p.preco_orig||'';
  document.getElementById('mPromoNovo').value=p.preco_novo||'';
  document.getElementById('mPromoIni').value=p.data_ini||'';
  document.getElementById('mPromoFim').value=p.data_fim||'';
  _fotoPromo = ''; // reset - sÃ³ muda se escolher nova foto
  var img=document.getElementById('mPromoFotoImg');
  var em=document.getElementById('mPromoFotoEmoji');
  if(p.foto){ if(img){img.src=p.foto+'?t='+Date.now();img.style.display='block';} if(em)em.style.display='none'; }
  else { if(img){img.src='';img.style.display='none';} if(em)em.style.display=''; }
  document.getElementById('wApagarPromo').style.display='block';
  document.getElementById('mPromo').classList.add('a');
}
function prevFoto(e){
  var f=e.target.files[0];if(!f)return;
  var r=new FileReader();
  r.onload=function(ev){
    comprimirImg(ev.target.result, 300, 0.6, function(compressed){
      _fotoPromo = compressed;
      var img = document.getElementById('mPromoFotoImg');
      var emoji = document.getElementById('mPromoFotoEmoji');
      if(img){ img.src=compressed; img.style.display='block'; }
      if(emoji){ emoji.style.display='none'; }
      var kb=Math.round(compressed.length/1024);
      toast('âœ… Foto pronta: '+kb+'KB'+(kb>20?' âš ï¸ grande':''));
    });
  };
  r.readAsDataURL(f);
  try{e.target.value='';}catch(x){}
}
async function guardarPromo(){
  var id=document.getElementById('mPromoId').value;
  var nome=document.getElementById('mPromoNome').value.trim();
  if(!nome){toast('âš ï¸ Nome obrigatÃ³rio');return;}
  var pid=id||uid();
  var fotoUrl='';
  if(_fotoPromo&&_fotoPromo.startsWith('data:')){
    toast('â³ A enviar foto...');
    // Usar timestamp no path para evitar cache do browser
    var fPath='promos/'+pid+'_'+Date.now()+'.jpg';
    fotoUrl=await sbImgUp('marinha',fPath,_fotoPromo);
    if(!fotoUrl)toast('âš ï¸ Foto nÃ£o enviada',3000);
  } else if(id){
    var ep=DB.promos.find(function(x){return x.id===id;});
    fotoUrl=ep?ep.foto||'':'';
  }
  toast('â³ A guardar...');
  var d={
    id:pid,nome:nome,
    emoji:document.getElementById('mPromoEmoji').value,
    foto:fotoUrl,
    preco_orig:document.getElementById('mPromoOrig').value,
    preco_novo:document.getElementById('mPromoNovo').value,
    data_ini:document.getElementById('mPromoIni').value,
    data_fim:document.getElementById('mPromoFim').value
  };
  if(id){var p=DB.promos.find(function(x){return x.id===id;});if(p)Object.assign(p,d);}
  else DB.promos.push(d);
  var ok=await sbUp('promos',d);
  // Garantir que DB local tem URL nova
  var pLocal=DB.promos.find(function(x){return x.id===pid;});
  if(pLocal)pLocal.foto=fotoUrl;
  fecharModal('mPromo');
  renderPromos();
  toast(ok?'âœ… Guardado':'âš ï¸ Erro');
}
async function apagarPromo(){
  var id=document.getElementById('mPromoId').value;
  if(!confirm('Apagar promoÃ§Ã£o?'))return;
  await sbDel('promos',id);
  DB.promos=DB.promos.filter(function(x){return x.id!==id;});
  fecharModal('mPromo');renderPromos();toast('ğŸ—‘ï¸ Removida');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  FOLHETO
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function addFolheto(e){
  var files=Array.prototype.slice.call(e.target.files);if(!files.length)return;
  toast('â³ A comprimir...');
  var n=0,total=files.length;
  files.forEach(function(f){
    var r=new FileReader();
    r.onload=async function(ev){
      // Comprimir em 2 passos atÃ© ficar abaixo de 100KB
      function comprimir(src, w, q, cb){
        var img=new Image();
        img.onload=function(){
          var iw=img.width,ih=img.height;
          if(iw>ih){if(iw>w){ih=Math.round(ih*w/iw);iw=w;}}
          else{if(ih>w){iw=Math.round(iw*w/ih);ih=w;}}
          var cv=document.createElement('canvas');
          cv.width=iw;cv.height=ih;
          cv.getContext('2d').drawImage(img,0,0,iw,ih);
          var out=cv.toDataURL('image/jpeg',q);
          // Se ainda > 130KB, reduzir mais
          if(out.length>175000){
            cv.width=Math.round(iw*0.6);cv.height=Math.round(ih*0.6);
            cv.getContext('2d').drawImage(img,0,0,cv.width,cv.height);
            out=cv.toDataURL('image/jpeg',0.45);
          }
          cb(out);
        };
        img.src=src;
      }
      comprimir(ev.target.result, 600, 0.65, async function(compressed){
        var kb=Math.round(compressed.length/1024);
        var id=uid();
        var obj={id:id,nome:f.name,data:compressed,adicionado:hoje()};
        DB.folhetos.push(obj);
        // Guardar no IDB local sempre
        await idbSet('F_'+id,compressed);
        // Tentar guardar no Supabase
        var url=await sbImgUp('marinha','folhetos/'+id+'.jpg',compressed);
        var dataGuardar=url||'';
        await sbUp('folhetos',{id:id,nome:f.name,data:dataGuardar,adicionado:hoje()});
        // cache local
        if(!url) DB.folhetos[DB.folhetos.length-1].data=compressed;
        n++;
        if(n===total){
          renderFolheto();
          toast(url?'âœ… '+n+' pÃ¡gina(s) adicionada(s)':'âš ï¸ '+n+' pÃ¡g. guardada(s) sÃ³ localmente (criar bucket "marinha" no Supabase)');
        }
      });
    };
    r.readAsDataURL(f);
  });
  try{e.target.value='';}catch(x){}
}
function renderFolheto(){
  var el=document.getElementById('stripFol');
  el.innerHTML=DB.folhetos.map(function(f,i){
    return '<div class="fThumb" onclick="abrirViewer('+i+')">'+(f.data?'<img src="'+f.data+'" alt="">':'ğŸ–¼ï¸')+'</div>';
  }).join('');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  VIEWER
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
var _vIdx=0,_vImgs=[],_vTx=0;
function abrirViewer(i){
  _vImgs=DB.folhetos.filter(function(f){return f.data;});
  if(!_vImgs.length){toast('Imagens a carregar...');return;}
  _vIdx=Math.max(0,Math.min(i,_vImgs.length-1));
  var tr=document.getElementById('vTrack');
  tr.style.width=(_vImgs.length*100)+'vw';
  tr.innerHTML=_vImgs.map(function(f){return'<div class="vSlide"><img src="'+f.data+'" alt=""></div>';}).join('');
  updViewer();
  document.getElementById('viewer').classList.add('a');
  tr.addEventListener('touchstart',function(e){_vTx=e.touches[0].clientX;},{passive:true});
  tr.addEventListener('touchend',function(e){var dx=e.changedTouches[0].clientX-_vTx;if(Math.abs(dx)>40)navV(dx<0?1:-1);});
}
function updViewer(){
  document.getElementById('vTrack').style.transform='translateX(-'+(_vIdx*100)+'vw)';
  document.getElementById('vCount').textContent=(_vIdx+1)+' / '+_vImgs.length;
}
function navV(d){_vIdx=Math.max(0,Math.min(_vImgs.length-1,_vIdx+d));updViewer();}
function fecharViewer(){document.getElementById('viewer').classList.remove('a');}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  SCANNER
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
var _stream=null,_face='environment',_si=null,_det=null;
function iniciarCam(){
  if(!navigator.mediaDevices){toast('âš ï¸ CÃ¢mara sÃ³ em HTTPS');return;}
  if(window.BarcodeDetector&&!_det)_det=new BarcodeDetector({formats:['qr_code']});
  document.getElementById('sPrincipal').style.display='none';
  document.getElementById('cWrap').classList.add('a');
  document.getElementById('sCamStatus').textContent='A aceder...';
  navigator.mediaDevices.getUserMedia({video:{facingMode:_face},audio:false})
    .then(function(s){_stream=s;var v=document.getElementById('qrVid');v.srcObject=s;v.play();v.onloadedmetadata=function(){document.getElementById('sCamStatus').textContent=_det?'âœ… Aponte para o QR':'âš ï¸ Sem suporte auto';if(_det)iniciarLeitura();};})
    .catch(function(e){document.getElementById('sCamStatus').textContent='âš ï¸ '+e.message;});
}
function iniciarLeitura(){var v=document.getElementById('qrVid'),cd=false;_si=setInterval(function(){if(v.readyState<2||!_det)return;_det.detect(v).then(function(cs){if(cs.length&&!cd){cd=true;setTimeout(function(){cd=false;},3000);processarQR(cs[0].rawValue);}}).catch(function(){});},400);}
function pararCam(){clearInterval(_si);_si=null;if(_stream){_stream.getTracks().forEach(function(t){t.stop();});_stream=null;}var v=document.getElementById('qrVid');if(v)v.srcObject=null;var cw=document.getElementById('cWrap');if(cw)cw.classList.remove('a');var sp=document.getElementById('sPrincipal');if(sp)sp.style.display='';}
function lerQRFoto(e){var f=e.target.files[0];if(!f)return;toast('â³ A ler...');var img=new Image(),url=URL.createObjectURL(f);img.onload=function(){var cv=document.createElement('canvas');cv.width=img.width;cv.height=img.height;cv.getContext('2d').drawImage(img,0,0);URL.revokeObjectURL(url);if(!_det)_det=new BarcodeDetector({formats:['qr_code']});_det.detect(cv).then(function(cs){if(cs.length)processarQR(cs[0].rawValue);else toast('âš ï¸ QR nÃ£o encontrado');}).catch(function(){toast('âš ï¸ Erro');});};img.src=url;try{e.target.value='';}catch(x){}}
function pesqScan(q){
  var el=document.getElementById('resScan');
  if(!q||q.length<2){el.innerHTML='';return;}
  var fl=q.toLowerCase();
  var l=DB.clientes.filter(function(c){return c.nome.toLowerCase().includes(fl)||(c.tel||'').includes(q)||(c.num_cliente||'').includes(q);}).slice(0,5);
  el.innerHTML=l.map(function(c){return'<div class="sResItem" onclick="selecionarCli(\''+c.id+'\')"><div class="sAvatar">'+c.nome.charAt(0).toUpperCase()+'</div><div style="flex:1"><div style="color:#fff;font-weight:700">'+c.nome+'</div><div style="color:rgba(255,255,255,.5);font-size:12px">NÂº '+(c.num_cliente||'â€”')+' Â· '+(c.pts||0)+' pts</div></div></div>';}).join('');
}
function selecionarCli(id){document.getElementById('iScan').value='';document.getElementById('resScan').innerHTML='';processarQR('MARINHA:ID:'+id);}
function processarQR(txt){
  if(navigator.vibrate)navigator.vibrate(100);
  pararCam();
  var cli=null;
  var m=txt.match(/MARINHA:ID:([^\s]+)/i);
  if(m)cli=DB.clientes.find(function(c){return c.id===m[1];});
  if(!cli)cli=DB.clientes.find(function(c){return c.id===txt.trim();});
  var d=cli?descEur(cli.pts||0):0;
  document.getElementById('qrResTit').textContent=cli?'âœ… Cliente identificado':'â“ NÃ£o reconhecido';
  document.getElementById('qrResNome').textContent=cli?cli.nome+' â€” NÂº '+(cli.num_cliente||'â€”'):'CÃ³digo desconhecido';
  document.getElementById('qrResSub').textContent=cli?(cli.pts||0)+' pts Â· '+nivel(cli.pts||0)+(d>0?' Â· ğŸ’° '+d.toFixed(2)+'â‚¬':''):'';
  var cid=cli?cli.id:null;
  document.getElementById('qrBtnCompra').onclick=function(){fecharQR();abrirCompra(cid);};
  document.getElementById('qrRes').classList.add('a');
}
function fecharQR(){document.getElementById('qrRes').classList.remove('a');}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  COMPRA
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function abrirCompra(cliId){
  var sel=document.getElementById('mCompraCli');
  sel.innerHTML='<option value="">Selecionar...</option>';
  DB.clientes.forEach(function(c){var o=document.createElement('option');o.value=c.id;o.textContent=c.nome+' (NÂº '+(c.num_cliente||'â€”')+')';sel.appendChild(o);});
  if(cliId)sel.value=cliId;
  document.getElementById('mCompraVal').value='';
  document.getElementById('mCompraPrev').style.display='none';
  updCompra();
  document.getElementById('mCompra').classList.add('a');
}
function updCompra(){
  var id=document.getElementById('mCompraCli').value;
  var c=DB.clientes.find(function(x){return x.id===id;});
  var el=document.getElementById('mCompraDesc');
  if(!c){el.innerHTML='';return;}
  var d=descEur(c.pts||0);
  el.innerHTML=d>0?'<div style="background:rgba(39,174,96,.1);border-radius:10px;padding:10px;font-size:14px;color:var(--gr);font-weight:700;margin-bottom:10px">ğŸ’° '+d.toFixed(2)+'â‚¬ de desconto disponÃ­vel</div>':'<div style="font-size:13px;color:var(--mu);margin-bottom:10px">'+(c.pts||0)+'/'+DB.cfg.ptsDesc+' pts para 1â‚¬</div>';
  calcCompra();
}
function calcCompra(){
  var v=parseFloat(document.getElementById('mCompraVal').value)||0;
  var pts=Math.floor(v*(DB.cfg.ptsEuro||10));
  var el=document.getElementById('mCompraPrev');
  if(v>0){el.style.display='block';el.textContent='+'+pts+' pontos por esta compra';}
  else el.style.display='none';
}
async function confirmarCompra(){
  var cliId=document.getElementById('mCompraCli').value;
  var val=parseFloat(document.getElementById('mCompraVal').value)||0;
  if(!cliId){toast('âš ï¸ Selecione um cliente');return;}
  if(val<=0){toast('âš ï¸ Insira o valor');return;}
  var c=DB.clientes.find(function(x){return x.id===cliId;});if(!c)return;
  var ptsG=Math.floor(val*(DB.cfg.ptsEuro||10));
  var dD=descEur(c.pts||0);
  var ptsU=dD>0?dD*(DB.cfg.ptsDesc||100):0;
  c.pts=Math.max(0,(c.pts||0)+ptsG-ptsU);
  c.visitas=(c.visitas||0)+1;
  c.poupado=(parseFloat(c.poupado)||0)+dD;
  if(!c.historico)c.historico=[];
  c.historico.unshift({desc:'Compra '+val.toFixed(2)+'â‚¬',pts:ptsG,desconto:dD,data:new Date().toISOString()});
  toast('â³ A guardar...');
  var ok=await sbUp('clientes',c);
  fecharModal('mCompra');
  renderDash();renderCli('');
  if(navigator.vibrate)navigator.vibrate([100,50,100]);
  if(ok){
    document.getElementById('rNome').textContent=c.nome;
    document.getElementById('rPts').textContent='+'+ptsG+' pontos ganhos';
    document.getElementById('rTotal').textContent='Total: '+(c.pts||0)+' pontos';
    document.getElementById('rDesc').textContent=dD>0?'ğŸ’° Desconto: '+dD.toFixed(2)+'â‚¬':'';
    qrDraw('MARINHA:ID:'+c.id,document.getElementById('rQR'),true);
    document.getElementById('mRecibo').classList.add('a');
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  CONFIG
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderCfg(){
  document.getElementById('cfgNome').value=DB.cfg.nomeLoja||'';
  document.getElementById('cfgPtsEuro').value=DB.cfg.ptsEuro||10;
  document.getElementById('cfgPtsDesc').value=DB.cfg.ptsDesc||100;
  var url=window.location.origin+window.location.pathname.replace(/admin\.html$/,'')+'index.html';
  document.getElementById('cfgLink').textContent=url;
  qrDraw(url,document.getElementById('qrCfg'),false);
}
async function guardarCfg(){
  DB.cfg.nomeLoja=document.getElementById('cfgNome').value;
  DB.cfg.ptsEuro=parseInt(document.getElementById('cfgPtsEuro').value)||10;
  DB.cfg.ptsDesc=parseInt(document.getElementById('cfgPtsDesc').value)||100;
  var ok=await sbUp('config',{id:1,nome_loja:DB.cfg.nomeLoja,pts_euro:DB.cfg.ptsEuro,pts_desc:DB.cfg.ptsDesc});
  document.getElementById('cabNome').textContent=DB.cfg.nomeLoja||'MARINHA';
  toast(ok?'âœ… Guardado':'âš ï¸ Erro');
}
function copiarLink(){var url=window.location.origin+window.location.pathname.replace(/admin\.html$/,'')+'index.html';navigator.clipboard.writeText(url).then(function(){toast('âœ… Copiado!');}).catch(function(){toast(url,5000);});}
function imprimirQR(){var url=window.location.origin+window.location.pathname.replace(/admin\.html$/,'')+'index.html';var w=window.open('','_blank');w.document.write('<html><body style="text-align:center;padding:40px;font-family:sans-serif"><h1>âš“ '+(DB.cfg.nomeLoja||'MARINHA')+'</h1><p>Programa de fidelizaÃ§Ã£o</p>'+document.getElementById('qrCfg').outerHTML+'<p>'+url+'</p><script>window.onload=function(){window.print()}<\/script></body></html>');w.document.close();}
function exportar(){var b=new Blob([JSON.stringify(DB,null,2)],{type:'application/json'});var a=document.createElement('a');a.href=URL.createObjectURL(b);a.download='marinha_backup.json';a.click();}


// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  COMPRIMIR IMAGEM
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function comprimirImg(base64, maxW, qualidade, cb){
  var img=new Image();
  img.onload=function(){
    var w=img.width, h=img.height;
    // Cortar quadrado central
    var size=Math.min(w,h);
    var sx=Math.floor((w-size)/2);
    var sy=Math.floor((h-size)/2);
    var cv=document.createElement('canvas');
    cv.width=maxW; cv.height=maxW;
    cv.getContext('2d').drawImage(img,sx,sy,size,size,0,0,maxW,maxW);
    cb(cv.toDataURL('image/jpeg',qualidade));
  };
  img.src=base64;
}
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  QR DRAW
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function qrDraw(txt,el,inv){
  if(!el)return;
  var sz=parseInt(el.getAttribute('width'))||150;
  var mat=qrMat(txt),n=mat.length,cell=sz/n;
  var bg=inv?'#0a1628':'#fff',fg=inv?'#fff':'#0a1628';
  var h='<rect width="'+sz+'" height="'+sz+'" fill="'+bg+'"/>';
  for(var r=0;r<n;r++)for(var c=0;c<n;c++)if(mat[r][c])h+='<rect x="'+(c*cell).toFixed(1)+'" y="'+(r*cell).toFixed(1)+'" width="'+(cell+.3).toFixed(1)+'" height="'+(cell+.3).toFixed(1)+'" fill="'+fg+'"/>';
  el.innerHTML=h;
}
function qrMat(t){var b=[],i,cd;for(i=0;i<t.length;i++){cd=t.charCodeAt(i);if(cd<128)b.push(cd);else if(cd<2048){b.push(0xC0|(cd>>6));b.push(0x80|(cd&63));}else{b.push(0xE0|(cd>>12));b.push(0x80|((cd>>6)&63));b.push(0x80|(cd&63));}}var v=2;if(b.length>14)v=3;if(b.length>26)v=4;if(b.length>42)v=5;if(b.length>60)v=6;if(b.length>84)v=7;if(b.length>110)v=9;return qrBld(b,v);}
function qrBld(d,v){var n=17+v*4,m=[],f=[];for(var i=0;i<n;i++){m[i]=[];f[i]=[];for(var j=0;j<n;j++){m[i][j]=false;f[i][j]=false;}}function sf(r,c,val){if(r>=0&&r<n&&c>=0&&c<n){m[r][c]=val;f[r][c]=true;}}function fp(tr,tc){for(var r=-1;r<=7;r++)for(var c=-1;c<=7;c++)sf(tr+r,tc+c,(r>=0&&r<7&&c>=0&&c<7)&&(r===0||r===6||c===0||c===6||(r>=2&&r<=4&&c>=2&&c<=4)));}fp(0,0);fp(0,n-7);fp(n-7,0);for(var i=8;i<n-8;i++){sf(6,i,i%2===0);sf(i,6,i%2===0);}sf(4*v+9,8,true);var ap={2:[6,18],3:[6,22],4:[6,26],5:[6,30],6:[6,34],7:[6,22,38],9:[6,26,46]}[v]||[];for(var ai=0;ai<ap.length;ai++)for(var aj=0;aj<ap.length;aj++){var ar=ap[ai],ac=ap[aj];if(!f[ar][ac])for(var dr=-2;dr<=2;dr++)for(var dc=-2;dc<=2;dc++)sf(ar+dr,ac+dc,dr===0&&dc===0||Math.abs(dr)===2||Math.abs(dc)===2);}var cap={2:28,3:44,4:64,5:86,6:108,7:124,9:154}[v]||44;var s=[0x04,d.length];for(var i=0;i<d.length;i++)s.push(d[i]);var pad=[0xEC,0x11];while(s.length<cap)s.push(pad[(s.length-2-d.length)%2]);var bits=[];for(var i=0;i<s.length;i++)for(var b=7;b>=0;b--)bits.push((s[i]>>b)&1);var bi=0,up=true;for(var col=n-1;col>=1;col-=2){if(col<=6)col--;for(var row=up?n-1:0;up?row>=0:row<n;row+=up?-1:1){for(var dc2=0;dc2<2;dc2++){var c2=col-dc2;if(!f[row][c2])m[row][c2]=bi<bits.length?bits[bi++]===1:false;}}up=!up;}for(var r=0;r<n;r++)for(var c=0;c<n;c++){if(!f[r][c]&&(r+c)%2===0)m[r][c]=!m[r][c];}return m;}

document.addEventListener('click',function(e){if(e.target.classList.contains('modal'))e.target.classList.remove('a');});
</script>
</body>
</html>
